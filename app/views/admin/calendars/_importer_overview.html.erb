<% unless calendar.new_record? %>
  <% retry_button = nil %>

  <%# Stale calendar warning - shown separately above %>
  <% if calendar.checksum_updated_at.present? && calendar.last_import_at.present? %>
    <% if calendar.checksum_updated_at < 6.month.ago || calendar.last_import_at < 6.month.ago %>
      <div role="alert" class="alert alert-warning mb-4">
        <%= icon(:warning, size: '5', css_class: 'shrink-0 stroke-current') %>
        <span>Potential stale calendar - not updated in over 6 months.</span>
      </div>
    <% end %>
  <% end %>

  <%# Error message - shown separately above %>
  <% if calendar.calendar_state.error? || calendar.calendar_state.bad_source? %>
    <% retry_button = :error %>
    <div role="alert" class="alert alert-error mb-4">
      <%= icon(:x_circle, size: '5', css_class: 'shrink-0 stroke-current') %>
      <span><%= calendar.critical_error %></span>
    </div>
  <% end %>

  <%# Main status bar - all on one line %>
  <div class="flex flex-wrap items-center gap-x-6 gap-y-2 p-4 bg-base-200/50 border border-base-300 rounded-lg">
    <%# Status Badge %>
    <div class="flex items-center gap-2">
      <span class="text-sm font-medium text-base-content/60">Status:</span>
      <% if calendar.calendar_state.idle? %>
        <% retry_button = :idle %>
        <span class="badge badge-success gap-1">
          <%= icon(:check, size: '3') %>
          Success
        </span>
      <% elsif calendar.calendar_state.in_queue? || calendar.calendar_state.in_worker? %>
        <span class="badge badge-info gap-1">
          <span class="loading loading-spinner loading-xs"></span>
          Importing...
        </span>
      <% elsif calendar.calendar_state.error? || calendar.calendar_state.bad_source? %>
        <span class="badge badge-error gap-1">
          <%= icon(:x, size: '3') %>
          Error
        </span>
      <% end %>
    </div>

    <% if calendar.checksum_updated_at.present? %>
      <div class="flex items-center gap-2 text-sm">
        <span class="text-base-content/60">Source changed:</span>
        <span class="font-medium"><%= time_ago_in_words(calendar.checksum_updated_at) %> ago</span>
      </div>
    <% end %>

    <% if calendar.last_import_at.present? %>
      <div class="flex items-center gap-2 text-sm">
        <span class="text-base-content/60">Last import:</span>
        <span class="font-medium"><%= time_ago_in_words(calendar.last_import_at) %> ago</span>
      </div>
    <% end %>

    <% if retry_button %>
      <div class="ml-auto">
        <%= simple_form_for :import, { url: import_admin_calendar_path(calendar) } do |f| %>
          <% if retry_button == :idle %>
            <%= f.submit 'Re-import now', class: 'btn btn-sm bg-placecal-orange hover:bg-orange-600 text-white border-placecal-orange' %>
          <% elsif retry_button == :error %>
            <%= f.submit 'Retry Import', class: 'btn btn-sm btn-error' %>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>

  <%# Notices - collapsible below %>
  <% if calendar.notices.present? %>
    <div class="collapse collapse-arrow bg-warning/10 border border-warning/30 rounded-lg mt-4">
      <input type="checkbox" />
      <div class="collapse-title font-medium text-warning-content flex items-center gap-2 py-3 min-h-0">
        <%= icon(:warning, size: '4') %>
        Import Notices
        <span class="badge badge-warning badge-sm"><%= calendar.notices.count %></span>
      </div>
      <div class="collapse-content">
        <ul class="space-y-1">
          <% calendar.notices.tally.each do |text, count| %>
            <li class="text-sm flex items-start gap-2">
              <span class="text-warning">â€¢</span>
              <span><%= text %><% if count > 1 %> <span class="badge badge-ghost badge-xs"><%= count %>x</span><% end %></span>
            </li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>
<% end %>
