<% unless calendar.new_record? %>
    <% problem = false %>
    <hr>
    <h3>Importing</h3>
    
    <% if calendar.calendar_state.idle? %>
	<p>
	    Status: success.
	    <% if calendar.last_import_at.present? %>
		Last imported <span title="<%= calendar.last_import_at %>"><%= time_ago_in_words(calendar.last_import_at) %></span> ago.
	    <% end %>
	</p>
    <% end %>

    <% if calendar.calendar_state.in_queue? || calendar.calendar_state.in_worker? %>
	<p>Status: loading.</p>
	<p>[cCc] Please check back in a few minutes</p>
    <% end %>

    <% if calendar.calendar_state.error? || calendar.calendar_state.bad_source? %>
	<% problem = true %>
	
	<!-- p>Status: error</p -->
	<div class="alert alert-warning" role="alert">
	    Error: <%= calendar.critical_error %>
	</div>
    <% end %>

    <% if calendar.notices.present? %>
	<% problem = true %>
	
	<h4>Notices</h4>
	<p>The following events could not be imported due to invalid data: </p>
	
        <ul id="calendar-notices">
            <% calendar.notices.tally.each do |text, count| %>
		<li><%= text %> <% if count > 1 %>(<%= count %> times)<% end %></li>
            <% end %>
        </ul>
	<p>[cCc] Please check your calendar is set up correctly and try again.</p>
    <% end %>
    
    <%= simple_form_for :import, { url: import_admin_calendar_path(calendar) } do |f| %>
	<% if problem %>
	    <%= f.submit 'Retry', class: 'btn btn-danger' %>
	<% else %>
	    <%= f.submit 'Import now', class: 'btn btn-secondary' %>
	<% end %>
    <% end %>

<% end %>


