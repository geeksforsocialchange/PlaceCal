<% unless calendar.new_record? %>
  <% retry_button = nil %>
  <hr class="my-6 border-gray-200">
  <h3 class="text-lg font-medium text-gray-900 mb-4">Import status</h3>

  <% if calendar.checksum_updated_at.present? && calendar.last_import_at.present? %>
    <% if calendar.checksum_updated_at < 6.month.ago || calendar.last_import_at < 6.month.ago %>
      <div class="rounded-md bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4" role="alert">
        <h4 class="text-sm font-medium text-yellow-800">Potential stale calender</h4>
        <p class="text-sm text-yellow-700 mt-1">Is this calender still active? It has not been updated in over 6 months</p>
      </div>
    <% end %>
  <% end %>

  <% if calendar.calendar_state.idle? %>
    <% retry_button = :idle %>
    <p class="mb-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">success</span></p>
  <% end %>

  <% if calendar.calendar_state.in_queue? || calendar.calendar_state.in_worker? %>
    <p class="mb-2"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">loading</span></p>
    <p class="text-gray-600 mb-4">Please check back in a few minutes</p>
  <% end %>

  <% if calendar.calendar_state.error? || calendar.calendar_state.bad_source? %>
    <% retry_button = :error %>

    <p class="mb-2"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">error</span></p>

    <div class="rounded-md bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4" role="alert">
      <p class="text-sm text-yellow-700">Error: <%= calendar.critical_error %></p>
    </div>
  <% end %>


  <% if calendar.checksum_updated_at.present? %>
    <p class="text-gray-700 mb-2">
    <strong>Source data last changed <%= time_ago_in_words(calendar.checksum_updated_at) %> ago</strong> (<%= calendar.checksum_updated_at %>)
    </p>
  <% end %>

  <% if calendar.last_import_at.present? %>
    <p class="text-gray-700 mb-4">
    <strong>Last import ran <%= time_ago_in_words(calendar.last_import_at) %> ago</strong> (<%= calendar.last_import_at %>)
    </p>
  <% end %>

  <% if calendar.notices.present? %>
    <% retry_button = :error %>

    <h4 class="text-md font-medium text-gray-900 mb-2">Notices</h4>
    <p class="text-gray-600 mb-2">The following events could not be imported due to invalid data: </p>

    <ul id="calendar-notices" class="list-disc pl-6 mb-4 space-y-1 text-gray-700">
      <% calendar.notices.tally.each do |text, count| %>
        <li><%= text %> <% if count > 1 %>(<%= count %> times)<% end %></li>
      <% end %>
    </ul>
    <p class="text-gray-600 mb-4">Please check your calendar is set up correctly and try again.</p>
  <% end %>

  <% if retry_button %>
    <%= simple_form_for :import, { url: import_admin_calendar_path(calendar) } do |f| %>
      <% if retry_button == :idle %>
        <%= f.submit 'Re-import now', class: 'inline-flex items-center px-4 py-2 text-sm font-medium rounded-md text-white bg-placecal-orange hover:bg-orange-600' %>
      <% elsif retry_button == :error %>
        <%= f.submit 'Retry', class: 'inline-flex items-center px-4 py-2 text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700' %>
      <% end %>
    <% end %>
  <% end %>

<% end %>


