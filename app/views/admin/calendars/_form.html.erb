<%= simple_form_for [:admin, @calendar], html: { data: { controller: 'calendar-tabs live-validation' } } do |f| %>

  <% unless @calendar.new_record? %>
    <%= render('importer_overview', calendar: @calendar) %>
  <% end %>

  <%# Radio Tabs - daisyUI tabs-lift %>
  <div role="tablist" class="tabs tabs-lift mt-6">
    <input type="radio" name="calendar_tabs" class="tab" aria-label="üìã Settings" data-calendar-tabs-target="tab" data-hash="settings" checked="checked" />
    <div class="tab-content bg-base-100 border-base-300 p-6" data-calendar-tabs-target="panel" data-section="settings">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <%# Left Column - Details %>
        <div class="space-y-6">
          <div>
            <h2 class="text-lg font-bold mb-1">Calendar Details</h2>
            <p class="text-sm text-base-content/60 mb-4">Basic information about this event source.</p>
          </div>

          <fieldset class="fieldset">
            <legend class="fieldset-legend">Partner Organiser <span class="text-error">*</span></legend>
            <%= f.input_field :partner_id,
                              as: :select,
                              collection: options_for_organiser,
                              selected: (@partner&.id || @calendar.partner_id).to_s,
                              class: 'select select-bordered w-full',
                              data: { controller: "tom-select" } %>
            <p class="fieldset-label">Which group organises these events?</p>
          </fieldset>

          <fieldset class="fieldset">
            <legend class="fieldset-legend">Calendar Name <span class="text-error">*</span></legend>
            <%= f.input_field :name, class: 'input input-bordered w-full' %>
            <p class="fieldset-label">A simple description to help remember what this calendar is</p>
          </fieldset>

          <fieldset class="fieldset">
            <legend class="fieldset-legend">Source URL <span class="text-error">*</span></legend>
            <%= f.input_field :source, class: 'input input-bordered w-full font-mono text-sm', placeholder: 'https://your-domain.com/events.ics' %>
            <p class="fieldset-label"><%= t('admin.calendars.handbook_hint_html') %></p>
          </fieldset>

          <fieldset class="fieldset">
            <legend class="fieldset-legend">Import Mode</legend>
            <%= f.input_field :importer_mode,
                              as: :select,
                              collection: options_for_importer,
                              selected: @calendar.importer_mode || 'auto',
                              class: 'select select-bordered w-full' %>
          </fieldset>

          <div class="card bg-base-200/50 border border-base-300">
            <div class="card-body p-4">
              <h3 class="font-semibold text-sm flex items-center gap-2 mb-2">
                <%= icon(:info, size: '4', css_class: 'text-base-content/60') %>
                Supported Calendar Sources
              </h3>
              <ul class="text-xs text-base-content/70 space-y-1">
                <% calendar_import_sources do |name, domains| %>
                  <li class="flex items-start gap-2">
                    <span class="text-placecal-orange">‚Ä¢</span>
                    <span><strong><%= name %></strong> <span class="text-base-content/50">(<%= domains.join(', ') %>)</span></span>
                  </li>
                <% end %>
              </ul>
              <% if @calendar.importer_used.present? %>
                <p class="text-xs text-base-content/50 mt-3 pt-3 border-t border-base-300">
                  Last imported using: <span class="font-medium"><%= @calendar.importer_used %></span>
                </p>
              <% end %>
            </div>
          </div>
        </div>

        <%# Right Column - Location & Contact %>
        <div class="space-y-6">
          <div>
            <h2 class="text-lg font-bold mb-1">Location Settings</h2>
            <p class="text-sm text-base-content/60 mb-4">How should location information be handled for events?</p>
          </div>

          <fieldset class="fieldset bg-base-200/50 border border-base-300 rounded-box p-4">
            <legend class="fieldset-legend">Default Location</legend>
            <%= f.input_field :place_id,
                              as: :select,
                              collection: options_for_location,
                              include_blank: '(No default location)',
                              class: 'select select-bordered w-full bg-base-100',
                              data: { controller: "tom-select" } %>
            <p class="fieldset-label mt-2">Used when strategy requires a fallback location</p>
          </fieldset>

          <fieldset class="fieldset">
            <legend class="fieldset-legend">Location Strategy</legend>
            <p class="text-sm text-base-content/60 mb-4">Where should location information for this calendar come from?</p>
            <div class="space-y-3">
              <% Calendar.strategy.values.each do |strategy_value| %>
                <label class="flex items-start gap-3 p-3 rounded-lg border border-base-300 bg-base-100 hover:bg-base-200/50 cursor-pointer transition-colors has-[:checked]:border-placecal-orange has-[:checked]:bg-orange-50/50">
                  <%= f.radio_button :strategy, strategy_value, class: 'radio radio-warning mt-0.5' %>
                  <span class="text-sm leading-relaxed"><%= strategy_label([nil, strategy_value]) %></span>
                </label>
              <% end %>
            </div>
          </fieldset>

          <div class="divider"></div>

          <div>
            <h2 class="text-lg font-bold mb-1">Public Contact</h2>
            <p class="text-sm text-base-content/60 mb-4">
              Shown on event pages in the "Problem with this listing?" link.
            </p>
          </div>

          <div class="card bg-base-200/50 border border-base-300">
            <div class="card-body p-4 gap-4">
              <fieldset class="fieldset">
                <legend class="fieldset-legend">Contact Name</legend>
                <%= f.input_field :public_contact_name, class: 'input input-bordered input-sm w-full bg-base-100' %>
              </fieldset>

              <fieldset class="fieldset">
                <legend class="fieldset-legend">Contact Email</legend>
                <%= f.input_field :public_contact_email, class: 'input input-bordered input-sm w-full bg-base-100',
                    'data-validate-email': 'true',
                    'data-validate-email-message': 'Enter a valid email address' %>
              </fieldset>

              <fieldset class="fieldset">
                <legend class="fieldset-legend">Contact Phone</legend>
                <%= f.input_field :public_contact_phone, class: 'input input-bordered input-sm w-full bg-base-100' %>
              </fieldset>
            </div>
          </div>
        </div>
      </div>
    </div>

    <% unless @calendar.new_record? %>
      <input type="radio" name="calendar_tabs" class="tab" aria-label="üé´ Events" data-calendar-tabs-target="tab" data-hash="events" />
      <div class="tab-content bg-base-100 border-base-300 p-6" data-calendar-tabs-target="panel" data-section="events">
        <h2 class="text-lg font-bold mb-1 flex items-center gap-2">
          <%= icon(:event, size: '5') %>
          Events
          <span class="badge badge-neutral"><%= @calendar.events.count %></span>
        </h2>
        <p class="text-sm text-base-content/60 mb-6">Events imported from this calendar source.</p>

        <% upcoming_events = @calendar.events.where('dtstart >= ?', Time.current).order(:dtstart).limit(50) %>
        <% past_events = @calendar.events.where('dtstart < ?', Time.current).order(dtstart: :desc).limit(20) %>

        <% if upcoming_events.any? %>
          <h3 class="font-semibold mb-3 flex items-center gap-2">
            <span class="text-success">‚óè</span>
            Upcoming Events
            <span class="badge badge-success badge-sm"><%= upcoming_events.count %></span>
          </h3>
          <div class="overflow-x-auto mb-8">
            <table class="table table-sm table-zebra">
              <thead>
                <tr>
                  <th>Event</th>
                  <th>Date & Time</th>
                  <th>Location</th>
                </tr>
              </thead>
              <tbody>
                <% upcoming_events.each do |event| %>
                  <tr>
                    <td>
                      <div class="font-medium"><%= truncate(event.summary, length: 60) %></div>
                    </td>
                    <td class="whitespace-nowrap text-sm">
                      <%= event.dtstart.strftime('%a %d %b %Y, %H:%M') %>
                    </td>
                    <td class="text-sm text-base-content/70">
                      <% if event.address %>
                        <%= truncate(event.address.to_s, length: 40) %>
                      <% elsif event.partner %>
                        <%= event.partner.name %>
                      <% else %>
                        <span class="text-base-content/40">No location</span>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="text-center py-8 mb-8">
            <%= icon(:calendar, size: '10', css_class: 'mx-auto text-base-content/30', stroke_width: '1.5') %>
            <p class="mt-2 text-base-content/60">No upcoming events</p>
          </div>
        <% end %>

        <% if past_events.any? %>
          <div class="collapse collapse-arrow bg-base-200/50 border border-base-300 rounded-lg">
            <input type="checkbox" />
            <div class="collapse-title font-semibold flex items-center gap-2">
              <span class="text-base-content/50">‚óè</span>
              Recent Past Events
              <span class="badge badge-ghost badge-sm"><%= past_events.count %></span>
            </div>
            <div class="collapse-content">
              <div class="overflow-x-auto">
                <table class="table table-sm table-zebra">
                  <thead>
                    <tr>
                      <th>Event</th>
                      <th>Date & Time</th>
                      <th>Location</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% past_events.each do |event| %>
                      <tr class="opacity-70">
                        <td>
                          <div class="font-medium"><%= truncate(event.summary, length: 60) %></div>
                        </td>
                        <td class="whitespace-nowrap text-sm">
                          <%= event.dtstart.strftime('%a %d %b %Y, %H:%M') %>
                        </td>
                        <td class="text-sm text-base-content/70">
                          <% if event.address %>
                            <%= truncate(event.address.to_s, length: 40) %>
                          <% elsif event.partner %>
                            <%= event.partner.name %>
                          <% else %>
                            <span class="text-base-content/40">No location</span>
                          <% end %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <%# Spacer to push Admin tab right %>
      <div class="tab flex-1 cursor-default"></div>

      <input type="radio" name="calendar_tabs" class="tab" aria-label="‚öôÔ∏è Admin" data-calendar-tabs-target="tab" data-hash="admin" />
      <div class="tab-content bg-base-100 border-base-300 p-6" data-calendar-tabs-target="panel" data-section="admin">
        <h2 class="text-lg font-bold text-error mb-4">Danger Zone</h2>
        <div class="card bg-error/5 border border-error/20 max-w-xl">
          <div class="card-body p-4">
            <h3 class="font-semibold flex items-center gap-2">
              <%= icon(:warning, size: '5', css_class: 'text-error') %>
              Delete this calendar
            </h3>
            <p class="text-sm text-base-content/70 mt-2">
              Permanently remove this calendar and all <strong><%= @calendar.events.count %></strong> associated events. This action cannot be undone.
            </p>
            <div class="mt-4">
              <%= link_to admin_calendar_path(@calendar), method: :delete, class: "btn btn-error btn-sm", data: { confirm: "Delete this calendar permanently? All #{@calendar.events.count} associated events will also be deleted. This cannot be undone." } do %>
                <%= icon(:trash, size: '4') %>
                Delete Calendar
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <%= render Admin::SaveBarComponent.new(
    multi_step: true,
    tab_name: 'calendar_tabs',
    settings_hash: 'admin',
    storage_key: 'calendarTabAfterSave'
  ) %>
<% end %>
