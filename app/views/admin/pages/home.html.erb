<% content_for :title do %><%= t('admin.dashboard.title') %><% end %>

<% if user_has_no_rights?(current_user) -%>
  <div role="alert" class="alert alert-error mb-6">
    <%= icon(:warning, size: '6', css_class: 'shrink-0') %>
    <div>
      <h3 class="font-bold"><%= t('admin.missing_permissions.title') %></h3>
      <p><%= t('admin.missing_permissions.message') %></p>
    </div>
  </div>
<% end -%>

<%# Welcome Header with Quick Actions %>
<%
  hour = Time.current.hour
  greeting_key = if hour < 12 then 'morning' elsif hour < 17 then 'afternoon' else 'evening' end
%>
<div class="flex flex-wrap items-end justify-between gap-4 mb-6">
  <div>
    <h1 class="text-2xl font-bold text-base-content">
      <%= t("admin.dashboard.greeting.#{greeting_key}") %><% if @user.first_name.present? %>, <%= @user.first_name %><% end %>
    </h1>
    <p class="text-base-content/60 mt-1"><%= t('admin.dashboard.subtitle') %></p>
  </div>
  <div class="flex flex-wrap gap-2">
    <% [Partner, Calendar, User].each do |model| %>
      <% if policy(model).create? %>
        <%= link_to url_for(controller: model.table_name, action: :new),
                    data: { turbo: false },
                    class: "btn btn-sm bg-placecal-orange hover:bg-orange-600 text-white border-placecal-orange gap-2" do %>
          <%= icon(:plus, size: '4') %>
          New <%= model.name.titleize %>
        <% end %>
      <% end %>
    <% end %>
  </div>
</div>

<%# Stats Row - Compact horizontal cards %>
<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
  <%# Partners %>
  <%= render Admin::StatCardComponent.new(
        label: t('admin.dashboard.stats.partners'),
        value: @total_partners,
        icon: :partner
      ) %>

  <%# Calendars - Consolidated with tooltips %>
  <%= render Admin::StatCardComponent.new(
        label: t('admin.dashboard.stats.calendars'),
        value: nil,
        subtitle: t('admin.dashboard.stats.calendars_total', count: @total_calendars)
      ) do %>
    <div class="flex items-baseline gap-3">
      <div class="tooltip tooltip-bottom" data-tip="<%= t('admin.dashboard.tooltips.working_calendars') %>">
        <span class="text-lg font-bold text-success"><%= @working_calendars_count %></span>
        <span class="text-[10px] text-base-content/50 ml-0.5"><%= t('admin.dashboard.stats.working') %></span>
      </div>
      <div class="tooltip tooltip-bottom" data-tip="<%= t('admin.dashboard.tooltips.processing_calendars') %>">
        <span class="text-lg font-bold text-info"><%= @processing_calendars_count %></span>
        <span class="text-[10px] text-base-content/50 ml-0.5"><%= t('admin.dashboard.stats.queue') %></span>
      </div>
      <div class="tooltip tooltip-bottom" data-tip="<%= t('admin.dashboard.tooltips.problem_calendars', errors: @errored_calendars_count, bad_source: @bad_source_calendars_count) %>">
        <span class="text-lg font-bold <%= @problem_calendars_count > 0 ? 'text-error' : 'text-base-content/30' %>"><%= @problem_calendars_count %></span>
        <span class="text-[10px] text-base-content/50 ml-0.5"><%= t('admin.dashboard.stats.errors') %></span>
      </div>
    </div>
  <% end %>

  <%# Events this week %>
  <%= render Admin::StatCardComponent.new(
        label: t('admin.dashboard.stats.events_this_week'),
        value: @total_events_this_week,
        icon: :calendar
      ) %>

  <%# Handbook link %>
  <%= link_to "https://handbook.placecal.org/", target: "_blank", class: "card bg-base-100 border border-base-300 shadow-sm hover:border-placecal-orange/30 transition-all group" do %>
    <div class="card-body p-3">
      <div class="flex items-center justify-between">
        <span class="text-xs text-base-content/60 group-hover:text-placecal-orange transition-colors"><%= t('admin.dashboard.stats.need_help') %></span>
        <%= icon(:external_link, size: '4', css_class: 'text-base-content/30 group-hover:text-placecal-orange/50 transition-colors') %>
      </div>
      <div class="flex items-center gap-2 mt-1">
        <%= icon(:book, size: '5', css_class: 'text-base-content/40 group-hover:text-placecal-orange transition-colors') %>
        <span class="text-sm font-medium text-base-content/60 group-hover:text-base-content transition-colors"><%= t('admin.dashboard.links.handbook') %></span>
      </div>
    </div>
  <% end %>
</div>

<%# Bento Grid Dashboard %>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">

  <%# Sites Section %>
  <% if @sites.any? %>
    <%= render Admin::CardComponent.new(
          title: t('admin.dashboard.cards.your_sites'),
          icon: :site,
          header_link: admin_sites_path,
          header_link_text: t('admin.actions.view_all')
        ) do %>
      <div class="space-y-2">
        <% @sites.take(4).each do |site| %>
          <%= link_to edit_admin_site_path(site), class: "flex items-center justify-between gap-3 p-3 rounded-lg border border-base-300 hover:border-placecal-orange/30 hover:bg-base-200/50 transition-colors group" do %>
            <div class="flex-1 min-w-0">
              <h3 class="text-sm font-medium text-base-content group-hover:text-placecal-orange transition-colors truncate"><%= site.name %></h3>
              <p class="text-xs text-base-content/50"><%= site.slug %>.placecal.org</p>
            </div>
            <div class="text-right flex-shrink-0">
              <span class="text-sm font-semibold text-placecal-orange"><%= site.events_this_week %></span>
              <span class="text-xs text-base-content/50 ml-1">events</span>
            </div>
          <% end %>
        <% end %>
      </div>
      <% if @sites.count > 4 %>
        <%= link_to t('admin.dashboard.cards.view_all_sites', count: @sites.count), admin_sites_path, class: "text-xs text-placecal-orange hover:text-orange-600 mt-2 block text-center" %>
      <% end %>
    <% end %>
  <% end %>

  <%# Action Items Card %>
  <%= render Admin::CardComponent.new(
        title: t('admin.dashboard.cards.action_items'),
        icon: :clipboard,
        icon_class: @problem_calendars_count > 0 ? 'text-error' : 'text-success',
        variant: @problem_calendars_count > 0 ? :error : :success
      ) do %>
    <% if @errored_calendars.any? || @bad_source_calendars.any? %>
      <div class="space-y-1">
        <% @errored_calendars.take(5).each do |calendar| %>
          <%= link_to edit_admin_calendar_path(calendar), class: "flex items-center gap-2 py-2 px-2 rounded-lg bg-error/10 hover:bg-error/20 transition-colors group" do %>
            <%= icon(:warning, size: '4', css_class: 'text-error flex-shrink-0') %>
            <span class="text-sm truncate flex-1"><%= calendar.name %></span>
            <span class="text-xs text-error">Error</span>
          <% end %>
        <% end %>
        <% @bad_source_calendars.take(5).each do |calendar| %>
          <%= link_to edit_admin_calendar_path(calendar), class: "flex items-center gap-2 py-2 px-2 rounded-lg bg-warning/10 hover:bg-warning/20 transition-colors group" do %>
            <%= icon(:link, size: '4', css_class: 'text-warning flex-shrink-0') %>
            <span class="text-sm truncate flex-1"><%= calendar.name %></span>
            <span class="text-xs text-warning">Bad URL</span>
          <% end %>
        <% end %>
        <% if (@errored_calendars.count + @bad_source_calendars.count) > 10 %>
          <%= link_to admin_calendars_path(filter: 'problems'), class: "text-xs text-base-content/60 hover:text-placecal-orange mt-2 block" do %>
            <%= t('admin.dashboard.cards.view_all_issues', count: @errored_calendars.count + @bad_source_calendars.count) %>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="flex items-center gap-3 text-success">
        <%= icon(:check, size: '8') %>
        <div>
          <p class="font-medium"><%= t('admin.dashboard.cards.all_healthy') %></p>
          <p class="text-xs text-base-content/50"><%= t('admin.dashboard.cards.no_issues') %></p>
        </div>
      </div>
    <% end %>
  <% end %>

  <%# Upcoming Events %>
  <%= render Admin::CardComponent.new(
        title: t('admin.dashboard.cards.upcoming_events'),
        icon: :event
      ) do %>
    <% if @upcoming_events.any? %>
      <div class="space-y-1">
        <% @upcoming_events.take(6).each do |event| %>
          <div class="flex items-center gap-3 py-2 rounded-lg hover:bg-base-200/50 transition-colors">
            <div class="flex-shrink-0 w-10 text-center">
              <div class="text-[10px] font-medium text-placecal-orange uppercase"><%= event.dtstart.strftime('%b') %></div>
              <div class="text-lg font-bold text-base-content leading-tight"><%= event.dtstart.strftime('%d') %></div>
            </div>
            <div class="flex-1 min-w-0">
              <h4 class="text-sm font-medium text-base-content truncate"><%= event.summary %></h4>
              <p class="text-xs text-base-content/50 truncate">
                <%= event.dtstart.strftime('%H:%M') %>
                <% if event.partner %>Â· <%= event.partner.name %><% end %>
              </p>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="flex flex-col items-center justify-center py-6 text-base-content/40">
        <%= icon(:calendar, size: '8', css_class: 'mb-2', stroke_width: '1.5') %>
        <p class="text-sm"><%= t('admin.dashboard.cards.no_upcoming_events') %></p>
      </div>
    <% end %>
  <% end %>

  <%# Updated Partners %>
  <%= render Admin::CardComponent.new(
        title: t('admin.dashboard.cards.updated_partners'),
        icon: :partner
      ) do %>
    <% if @partners.any? %>
      <div class="space-y-1">
        <% @partners.take(6).each do |partner| %>
          <%= link_to edit_admin_partner_path(partner), class: "flex items-center gap-3 py-2 rounded-lg hover:bg-base-200/50 transition-colors group" do %>
            <% if partner.image.url %>
              <%= image_tag partner.image.url, class: "w-9 h-9 rounded-lg object-cover flex-shrink-0" %>
            <% else %>
              <div class="w-9 h-9 rounded-lg bg-base-300 flex items-center justify-center flex-shrink-0">
                <%= icon(:partner, size: '4', css_class: 'text-base-content/30', stroke_width: '1.5') %>
              </div>
            <% end %>
            <div class="flex-1 min-w-0">
              <h4 class="text-sm font-medium text-base-content group-hover:text-placecal-orange transition-colors truncate"><%= partner.name %></h4>
              <p class="text-xs text-base-content/50"><%= time_ago_in_words(partner.updated_at) %> ago</p>
            </div>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="flex flex-col items-center justify-center py-6 text-base-content/40">
        <%= icon(:partner, size: '8', css_class: 'mb-2', stroke_width: '1.5') %>
        <p class="text-sm"><%= t('admin.dashboard.cards.no_partners') %></p>
        <%= link_to t('admin.dashboard.cards.add_first_partner'), new_admin_partner_path, class: "text-xs text-placecal-orange hover:text-orange-600 mt-1" %>
      </div>
    <% end %>
  <% end %>

  <%# Updated Calendars %>
  <%= render Admin::CardComponent.new(
        title: t('admin.dashboard.cards.updated_calendars'),
        icon: :calendar
      ) do %>
    <% if @calendars.any? %>
      <div class="space-y-1">
        <% @calendars.take(6).each do |calendar| %>
          <%= link_to edit_admin_calendar_path(calendar), class: "flex items-center gap-3 py-2 rounded-lg hover:bg-base-200/50 transition-colors group" do %>
            <div class="w-9 h-9 rounded-lg bg-base-300 flex items-center justify-center flex-shrink-0">
              <%= icon(:calendar, size: '4', css_class: 'text-base-content/30', stroke_width: '1.5') %>
            </div>
            <div class="flex-1 min-w-0">
              <h4 class="text-sm font-medium text-base-content group-hover:text-placecal-orange transition-colors truncate"><%= calendar.name %></h4>
              <p class="text-xs text-base-content/50"><%= time_ago_in_words(calendar.updated_at) %> ago</p>
            </div>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="flex flex-col items-center justify-center py-6 text-base-content/40">
        <%= icon(:calendar, size: '8', css_class: 'mb-2', stroke_width: '1.5') %>
        <p class="text-sm"><%= t('admin.dashboard.cards.no_calendars') %></p>
      </div>
    <% end %>
  <% end %>

  <%# Updated Users %>
  <%= render Admin::CardComponent.new(
        title: t('admin.dashboard.cards.updated_users'),
        icon: :users
      ) do %>
    <% if @users.any? %>
      <div class="space-y-1">
        <% @users.take(6).each do |user| %>
          <%= link_to edit_admin_user_path(user), class: "flex items-center gap-3 py-2 rounded-lg hover:bg-base-200/50 transition-colors group" do %>
            <div class="w-9 h-9 rounded-lg bg-base-300 flex items-center justify-center flex-shrink-0">
              <%= icon(:user, size: '4', css_class: 'text-base-content/30', stroke_width: '1.5') %>
            </div>
            <div class="flex-1 min-w-0">
              <h4 class="text-sm font-medium text-base-content group-hover:text-placecal-orange transition-colors truncate"><%= user.full_name.presence || user.email %></h4>
              <p class="text-xs text-base-content/50"><%= time_ago_in_words(user.updated_at) %> ago</p>
            </div>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="flex flex-col items-center justify-center py-6 text-base-content/40">
        <%= icon(:users, size: '8', css_class: 'mb-2', stroke_width: '1.5') %>
        <p class="text-sm"><%= t('admin.dashboard.cards.no_users') %></p>
      </div>
    <% end %>
  <% end %>

  <%# Your Partnerships %>
  <% if @user_partnerships.any? %>
    <%= render Admin::CardComponent.new(
          title: t('admin.dashboard.cards.your_partnerships'),
          icon: :partnership
        ) do %>
      <div class="space-y-1">
        <% @user_partnerships.take(6).each do |partnership| %>
          <%= link_to edit_admin_tag_path(partnership), class: "flex items-center justify-between gap-3 py-2 rounded-lg hover:bg-base-200/50 transition-colors group" do %>
            <div class="flex-1 min-w-0">
              <h4 class="text-sm font-medium text-base-content group-hover:text-placecal-orange transition-colors truncate"><%= partnership.name %></h4>
              <p class="text-xs text-base-content/50"><%= pluralize(partnership.partners.count, 'partner') %></p>
            </div>
            <%= icon(:chevron_right, size: '4', css_class: 'text-base-content/30 group-hover:text-placecal-orange transition-colors flex-shrink-0') %>
          <% end %>
        <% end %>
      </div>
      <% if @user_partnerships.count > 6 %>
        <%= link_to t('admin.dashboard.cards.view_all_partnerships', count: @user_partnerships.count), admin_tags_path(type: 'Partnership'), class: "text-xs text-placecal-orange hover:text-orange-600 mt-3 block text-center" %>
      <% end %>
    <% end %>
  <% end %>

  <%# Quick Links %>
  <%= render Admin::CardComponent.new(
        title: t('admin.dashboard.cards.quick_links'),
        icon: :link
      ) do %>
    <div class="space-y-1">
      <%= link_to admin_calendars_path, class: "flex items-center gap-3 py-2 rounded-lg hover:bg-base-200/50 transition-colors group" do %>
        <%= icon(:calendar, size: '5', css_class: 'text-base-content/40 group-hover:text-placecal-orange transition-colors') %>
        <span class="text-sm text-base-content/70 group-hover:text-base-content transition-colors"><%= t('admin.dashboard.links.all_calendars') %></span>
      <% end %>
      <%= link_to admin_partners_path, class: "flex items-center gap-3 py-2 rounded-lg hover:bg-base-200/50 transition-colors group" do %>
        <%= icon(:partner, size: '5', css_class: 'text-base-content/40 group-hover:text-placecal-orange transition-colors') %>
        <span class="text-sm text-base-content/70 group-hover:text-base-content transition-colors"><%= t('admin.dashboard.links.all_partners') %></span>
      <% end %>
      <%= link_to "https://handbook.placecal.org/", target: "_blank", class: "flex items-center gap-3 py-2 rounded-lg hover:bg-base-200/50 transition-colors group" do %>
        <%= icon(:book, size: '5', css_class: 'text-base-content/40 group-hover:text-placecal-orange transition-colors') %>
        <span class="text-sm text-base-content/70 group-hover:text-base-content transition-colors"><%= t('admin.dashboard.links.handbook') %></span>
        <%= icon(:external_link, size: '3', css_class: 'text-base-content/30 ml-auto') %>
      <% end %>
      <%= link_to "http://discord.gfsc.studio/", target: "_blank", class: "flex items-center gap-3 py-2 rounded-lg hover:bg-base-200/50 transition-colors group" do %>
        <%= icon(:chat, size: '5', css_class: 'text-base-content/40 group-hover:text-placecal-orange transition-colors') %>
        <span class="text-sm text-base-content/70 group-hover:text-base-content transition-colors"><%= t('admin.dashboard.links.discord') %></span>
        <%= icon(:external_link, size: '3', css_class: 'text-base-content/30 ml-auto') %>
      <% end %>
    </div>
  <% end %>

</div>
