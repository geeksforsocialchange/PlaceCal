<% unless @tag.new_record? %>
  <p class="text-sm text-base-content/60 mb-4">
    Tag type: <span class="badge badge-ghost"><%= @tag.class %></span>
  </p>
<% end %>

<% if @tag.system_tag %>
  <div role="alert" class="alert bg-yellow-50 border-yellow-200 text-yellow-800 mb-6">
    <%= icon(:warning, size: '5', css_class: 'text-yellow-500') %>
    <span>This tag is used by the PlaceCal backend so you cannot change the Name or Slug values.</span>
  </div>
<% end %>

<%= simple_form_for @tag,
    as: :tag,
    url: (@tag.new_record? ? admin_tags_path : admin_tag_path),
    html: { class: 'space-y-6', data: { controller: 'live-validation' } } do |f| %>

  <%= render(Admin::ErrorComponent.new(@tag)) %>

  <div class="card bg-base-100 border border-base-300 shadow-sm">
    <div class="card-body p-6">
      <%= render Admin::SectionHeaderComponent.new(
        title: t('admin.sections.basic_information'),
        margin: 4
      ) %>

      <div class="fieldset">
        <label for="tag_name" class="fieldset-legend"><%= attr_label(:tag, :name) %> <span class="text-error"><%= t('admin.labels.required') %></span></label>
        <%= f.input_field :name, class: 'input input-bordered w-full', disabled: @tag.system_tag, id: 'tag_name' %>
      </div>

      <div class="fieldset">
        <label for="tag_slug" class="fieldset-legend"><%= attr_label(:tag, :slug) %></label>
        <%= f.input_field :slug, class: 'input input-bordered w-full', disabled: @tag.system_tag, id: 'tag_slug' %>
        <p class="fieldset-label"><%= t('admin.hints.leave_blank_to_autogenerate') %></p>
      </div>

      <div class="fieldset">
        <label for="tag_description" class="fieldset-legend"><%= attr_label(:tag, :description) %></label>
        <%= f.input_field :description, as: :text, class: 'textarea textarea-bordered w-full min-h-24', data: { controller: 'auto-expand' }, id: 'tag_description' %>
      </div>

      <% if current_user.root? %>
        <fieldset class="fieldset">
          <%= f.input :system_tag, wrapper: :tw_boolean, hint: t('admin.partnerships.fields.system_tag_hint') %>
        </fieldset>
      <% end %>

      <% if @tag.new_record? %>
        <fieldset class="fieldset">
          <legend class="fieldset-legend">Type</legend>
          <%= f.input_field :type,
              as: :select,
              collection: [['None', ''], ['Category', 'Category'], ['Facility', 'Facility'], ['Partnership', 'Partnership']],
              class: 'select select-bordered w-full' %>
          <p class="fieldset-label text-amber-600">
            <%= icon(:warning, size: '4', css_class: 'inline-block mr-1') %>
            Once set, this cannot be changed.
          </p>
        </fieldset>
      <% end %>
    </div>
  </div>

  <div class="card bg-base-100 border border-base-300 shadow-sm">
    <div class="card-body p-6">
      <div class="flex items-start gap-4 mb-4">
        <div class="shrink-0 w-11 h-11 rounded-xl bg-linear-to-br from-emerald-100 to-teal-100 flex items-center justify-center shadow-sm">
          <%= icon(:partner, size: '6', css_class: 'text-emerald-600') %>
        </div>
        <div>
          <h3 class="card-title text-lg"><%= t('admin.tags.sections.tagged_partners') %></h3>
          <p class="text-sm text-base-content/60 mt-0.5"><%= t('admin.tags.sections.tagged_partners_description') %></p>
        </div>
      </div>

      <%= render Admin::StackedListSelectorComponent.new(
        field_name: "tag[partner_ids][]",
        items: @tag.partners.order(:name),
        options: options_for_partners,
        permitted_ids: nil,
        icon_name: :partner,
        icon_color: "bg-emerald-100 text-emerald-600",
        empty_text: t('admin.empty.none_assigned', items: Partner.model_name.human(count: 2).downcase),
        add_placeholder: t('admin.placeholders.add_model', model: Partner.model_name.human.downcase),
        use_tom_select: true
      ) %>
    </div>
  </div>

  <% if show_assigned_user_field_for?(f) %>
    <div class="card bg-base-100 border border-base-300 shadow-sm">
      <div class="card-body p-6">
        <div class="flex items-start gap-4 mb-4">
          <div class="shrink-0 w-11 h-11 rounded-xl bg-linear-to-br from-purple-100 to-indigo-100 flex items-center justify-center shadow-sm">
            <%= icon(:users, size: '6', css_class: 'text-purple-600') %>
          </div>
          <div>
            <h3 class="card-title text-lg"><%= t('admin.tags.sections.assigned_users') %></h3>
            <p class="text-sm text-base-content/60 mt-0.5"><%= t('admin.tags.sections.assigned_users_description') %></p>
          </div>
        </div>

        <%= render Admin::StackedListSelectorComponent.new(
          field_name: "tag[user_ids][]",
          items: @tag.users.order(:last_name, :first_name),
          options: options_for_users,
          permitted_ids: nil,
          icon_name: :user,
          icon_color: "bg-purple-100 text-purple-600",
          empty_text: t('admin.empty.none_assigned', items: User.model_name.human(count: 2).downcase),
          add_placeholder: t('admin.placeholders.add_model', model: User.model_name.human.downcase),
          use_tom_select: true
        ) %>
      </div>
    </div>
  <% end %>

  <% if !@tag.new_record? && policy(@tag).destroy? %>
    <%= render Admin::DangerZoneComponent.new(
      title: t('admin.actions.delete_model', model: Tag.model_name.human),
      description: t('admin.danger_zone.delete_description', model: Tag.model_name.human.downcase),
      button_text: t('admin.actions.delete_model', model: Tag.model_name.human),
      button_path: admin_tag_path(@tag),
      confirm: t('admin.confirm.delete_permanent', model: Tag.model_name.human.downcase)
    ) %>
  <% end %>

  <%= render Admin::SaveBarComponent.new do |c| %>
    <% c.with_button do %>
      <%= f.submit t('admin.actions.save'), class: "btn bg-placecal-orange hover:bg-orange-600 text-white border-placecal-orange" %>
    <% end %>
  <% end %>
<% end %>
