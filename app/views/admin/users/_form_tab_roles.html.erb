<%# Permissions Tab %>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <%# Left column: Partnerships and Neighbourhoods %>
  <div class="space-y-6">
    <%# Partnerships %>
    <div class="card bg-base-200/50 border border-base-300">
      <div class="card-body p-4 gap-3">
        <h3 class="font-semibold flex items-center gap-2">
          <%= icon(:partnership, size: '4') %>
          <%= Partnership.model_name.human(count: 2) %>
        </h3>
        <p class="text-xs text-base-content/60"><%= t('admin.users.fields.partnerships_hint') %></p>

        <%= render Admin::StackedListSelectorComponent.new(
          field_name: "user[tag_ids][]",
          items: @user.partnerships.order(:name),
          options: options_for_user_partnerships,
          permitted_ids: nil,
          icon_name: :partnership,
          icon_color: "bg-amber-100 text-amber-600",
          empty_text: t('admin.empty.none_assigned', items: Partnership.model_name.human(count: 2).downcase),
          add_placeholder: t('admin.placeholders.add_model', model: Partnership.model_name.human.downcase),
          wrapper_class: "user_tags"
        ) %>
      </div>
    </div>

    <%# Neighbourhoods %>
    <div class="card bg-base-200/50 border border-base-300">
      <div class="card-body p-4 gap-3">
        <h3 class="font-semibold flex items-center gap-2">
          <%= icon(:map_pin, size: '4') %>
          <%= Neighbourhood.model_name.human(count: 2) %>
        </h3>
        <p class="text-xs text-base-content/60">
          <% if current_user.root? %>
            <%= t('admin.users.fields.neighbourhoods_hint_root') %>
          <% else %>
            <%= t('admin.users.fields.neighbourhoods_hint') %>
          <% end %>
        </p>

        <% if current_user.root? %>
          <%= nested_form_for(f, :neighbourhoods_users,
                add_text: t('admin.actions.add_model', model: Neighbourhood.model_name.human.downcase),
                add_class: 'btn btn-sm bg-placecal-orange hover:bg-orange-600 text-white border-placecal-orange mt-2',
                partial: 'neighbourhoods_user_fields') do %>
            <%= f.simple_fields_for :neighbourhoods_users do |nuf| %>
              <%= render 'neighbourhoods_user_fields', f: nuf %>
            <% end %>
          <% end %>
        <% else %>
          <%= render Admin::ItemBadgeListComponent.new(
            items: @user.neighbourhoods.order(:name),
            icon_name: :map_pin,
            icon_color: "bg-sky-100 text-sky-600",
            link_path: :admin_neighbourhood_path,
            empty_text: t('admin.empty.none_assigned', items: Neighbourhood.model_name.human(count: 2).downcase)
          ) %>
        <% end %>
      </div>
    </div>
  </div>

  <%# Right column: Sites and Partners %>
  <div class="space-y-6">
    <%# Sites (read-only display) %>
    <div class="card bg-base-200/50 border border-base-300">
      <div class="card-body p-4 gap-3">
        <h3 class="font-semibold flex items-center gap-2">
          <%= icon(:site, size: '4') %>
          <%= Site.model_name.human(count: 2) %>
        </h3>
        <p class="text-xs text-base-content/60"><%= t('admin.users.fields.sites_hint', default: 'Sites where this user is assigned as admin') %></p>

        <% sites = @user.sites.order(:name) %>
        <% if sites.any? %>
          <div class="space-y-2">
            <% sites.each do |site| %>
              <%= link_to edit_admin_site_path(site),
                  class: "group flex items-center gap-3 p-3 bg-base-200/80 rounded-xl border border-base-300/50 hover:border-base-300 transition-all" do %>
                <div class="shrink-0 w-9 h-9 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center">
                  <%= icon(:site, size: '5') %>
                </div>
                <span class="flex-1 font-medium text-sm text-base-content/90"><%= site.name %></span>
                <%= icon(:chevron_right, size: '4', css_class: 'text-base-content/30 group-hover:text-base-content/50') %>
              <% end %>
            <% end %>
          </div>
        <% else %>
          <div class="text-center py-6">
            <div class="inline-flex items-center justify-center w-12 h-12 rounded-xl bg-base-200 mb-2">
              <%= icon(:site, size: '6', css_class: 'text-base-content/30') %>
            </div>
            <p class="text-sm text-base-content/50"><%= t('admin.empty.none_assigned', items: Site.model_name.human(count: 2).downcase) %></p>
          </div>
        <% end %>
      </div>
    </div>

    <%# Partners %>
    <div class="card bg-base-200/50 border border-base-300">
      <div class="card-body p-4 gap-3">
        <h3 class="font-semibold flex items-center gap-2">
          <%= icon(:partner, size: '4') %>
          <%= Partner.model_name.human(count: 2) %>
        </h3>
        <p class="text-xs text-base-content/60"><%= t('admin.users.fields.partners_hint') %></p>

        <%= render Admin::StackedListSelectorComponent.new(
          field_name: "user[partner_ids][]",
          items: @user.partners.order(:name),
          options: options_for_partners(@user),
          permitted_ids: permitted_options_for_partners,
          icon_name: :partner,
          icon_color: "bg-emerald-100 text-emerald-600",
          empty_text: t('admin.empty.none_assigned', items: Partner.model_name.human(count: 2).downcase),
          add_placeholder: t('admin.placeholders.add_model', model: Partner.model_name.human.downcase),
          use_tom_select: true,
          wrapper_class: "user_partners"
        ) %>
      </div>
    </div>
  </div>
</div>
