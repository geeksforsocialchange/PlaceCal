<%= render(Admin::ErrorComponent.new(f.object)) %>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
  <%# Left Column - Personal Details %>
  <div class="space-y-6">
    <div>
      <h2 class="text-lg font-bold mb-1">Personal Details</h2>
      <p class="text-sm text-base-content/60 mb-4">Basic information about this user.</p>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <fieldset class="fieldset">
        <legend class="fieldset-legend">First Name</legend>
        <%= f.input_field :first_name, class: 'input input-bordered w-full' %>
      </fieldset>

      <fieldset class="fieldset">
        <legend class="fieldset-legend">Last Name</legend>
        <%= f.input_field :last_name, class: 'input input-bordered w-full' %>
      </fieldset>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <fieldset class="fieldset">
        <legend class="fieldset-legend">Email <span class="text-error">*</span></legend>
        <%= f.input_field :email, class: 'input input-bordered w-full' %>
      </fieldset>

      <fieldset class="fieldset">
        <legend class="fieldset-legend">Phone</legend>
        <%= f.input_field :phone, class: 'input input-bordered w-full' %>
      </fieldset>
    </div>

    <%# Avatar %>
    <fieldset class="fieldset">
      <legend class="fieldset-legend">Avatar</legend>
      <div data-controller="image-preview">
        <div class="flex items-start gap-4">
          <div class="shrink-0">
            <% if f.object.avatar.retina.url %>
              <div class="relative group">
                <%= image_tag f.object.avatar.retina.url, class: 'w-20 h-20 rounded-lg object-cover border border-base-300', data: { image_preview_target: "img" } %>
              </div>
            <% else %>
              <div class="w-20 h-20 rounded-lg bg-base-200 flex items-center justify-center border border-base-300" data-image-preview-target="placeholder">
                <%= icon(:user, size: '8', css_class: 'text-base-content/30', stroke_width: '1.5') %>
              </div>
              <%= image_tag "", style: 'display:none;', class: 'w-20 h-20 rounded-lg object-cover border border-base-300', data: { image_preview_target: "img" } %>
            <% end %>
          </div>
          <div class="flex-1">
            <label class="flex items-center gap-3 p-3 rounded-lg border-2 border-dashed border-base-300 hover:border-placecal-orange transition-colors cursor-pointer">
              <div class="flex-shrink-0 w-8 h-8 rounded-lg bg-placecal-orange/10 flex items-center justify-center">
                <%= icon(:upload, size: '4', css_class: 'text-placecal-orange') %>
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-medium">Choose file</p>
                <p class="text-xs text-base-content/50"><%= image_uploader_hint(f.object.avatar) %></p>
              </div>
              <%= f.input_field :avatar, as: :file, class: 'sr-only', data: { action: "change->image-preview#file", image_preview_target: "input" } %>
            </label>
          </div>
        </div>
      </div>
    </fieldset>
  </div>

  <%# Right Column - Role & Access %>
  <div class="space-y-6">
    <div>
      <h2 class="text-lg font-bold mb-1">Role & Permissions</h2>
      <p class="text-sm text-base-content/60 mb-4">What this user can access and manage.</p>
    </div>

    <fieldset class="fieldset">
      <legend class="fieldset-legend">Role</legend>
      <%= render Admin::RadioCardGroupComponent.new(
        form: f,
        attribute: :role,
        values: User.role.values,
        label_method: method(:role_label)
      ) %>
    </fieldset>

    <fieldset class="fieldset">
      <legend class="fieldset-legend">Partnerships</legend>
      <p class="fieldset-label mb-3">Grants access to add or remove partners from partnerships</p>
      <div class="user_tags">
        <%= f.input_field :tag_ids,
                  as: :select,
                  collection: options_for_tags,
                  multiple: true,
                  class: 'select select-bordered w-full',
                  data: { controller: "tom-select" } %>
      </div>
    </fieldset>
  </div>
</div>

<div class="divider my-8"></div>

<%# Partners & Neighbourhoods %>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
  <div class="card bg-base-200/50 border border-base-300">
    <div class="card-body p-4">
      <h3 class="font-semibold flex items-center gap-2 mb-2">
        <%= icon(:partner, size: '5', css_class: 'text-placecal-orange') %>
        Partners
      </h3>
      <p class="text-sm text-base-content/60 mb-3">Partners this user can edit, as well as their associated calendars.</p>
      <div class="user_partners">
        <%= f.input_field :partner_ids,
                  as: :select,
                  collection: options_for_partners(params[:id] ? User.find(params[:id]) : nil),
                  selected: @partners || @user.partners.pluck(:id),
                  multiple: true,
                  class: 'select select-bordered w-full bg-base-100',
                  data: {
                    controller: @user_partners_controller,
                    "user-partners-permitted-partners-value": permitted_options_for_partners
                  } %>
      </div>
    </div>
  </div>

  <div class="card bg-base-200/50 border border-base-300">
    <div class="card-body p-4">
      <h3 class="font-semibold flex items-center gap-2 mb-2">
        <%= icon(:map_pin, size: '5', css_class: 'text-info') %>
        Neighbourhoods
      </h3>
      <% if current_user.root? %>
        <p class="text-sm text-base-content/60 mb-3">Grants access to every partner and calendar in these neighbourhoods. Use with care!</p>
        <div class="user_neighbourhoods">
          <%= f.input_field :neighbourhood_ids,
            as: :select,
            collection: options_for_user_neighbourhoods(f.object),
            multiple: true,
            class: 'select select-bordered w-full bg-base-100',
            data: { controller: "tom-select" } %>
        </div>
      <% else %>
        <p class="text-sm text-base-content/60 mb-3">Neighbourhoods this user has access to.</p>
        <% if @user.neighbourhoods.any? %>
          <div class="flex flex-wrap gap-2">
            <% @user.neighbourhoods.order(:name).each do |hood| %>
              <%= link_to hood.name, admin_neighbourhood_path(hood), class: "badge badge-outline hover:badge-primary" %>
            <% end %>
          </div>
        <% else %>
          <p class="text-sm text-base-content/50 italic">No neighbourhoods assigned</p>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
