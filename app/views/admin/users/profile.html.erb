<% content_for :title do %><%= t('admin.users.profile.title') %><% end %>

<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-2xl font-semibold"><%= t('admin.users.profile.title') %></h1>
    <p class="text-base-content/60 mt-1"><%= current_user.email %></p>
  </div>
  <% if current_user.root? %>
    <%= link_to edit_admin_user_path(current_user), class: "btn btn-ghost btn-sm gap-2" do %>
      <%= icon(:cog, size: '4') %>
      Full Edit
    <% end %>
  <% end %>
</div>

<%= simple_form_for current_user, as: :user, method: :patch, url: update_profile_admin_user_path(current_user), html: { class: "space-y-6", data: { controller: 'live-validation' } } do |f| %>
  <%= render(Admin::ErrorComponent.new(current_user)) %>

  <%# Basic Information %>
  <div class="card bg-base-100 border border-base-300 shadow-sm">
    <div class="card-body p-6">
      <%= render Admin::SectionHeaderComponent.new(
        title: t('admin.users.sections.personal_details'),
        description: t('admin.users.sections.personal_description'),
        margin: 4
      ) %>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <fieldset class="fieldset">
          <legend class="fieldset-legend"><%= attr_label(:user, :first_name) %></legend>
          <%= f.input_field :first_name, class: 'input input-bordered w-full' %>
        </fieldset>

        <fieldset class="fieldset">
          <legend class="fieldset-legend"><%= attr_label(:user, :last_name) %></legend>
          <%= f.input_field :last_name, class: 'input input-bordered w-full' %>
        </fieldset>
      </div>

      <fieldset class="fieldset">
        <legend class="fieldset-legend"><%= attr_label(:user, :email) %></legend>
        <%= f.input_field :email, class: 'input input-bordered w-full', disabled: true %>
        <p class="fieldset-label">Contact support to change your email address.</p>
      </fieldset>

      <fieldset class="fieldset">
        <legend class="fieldset-legend"><%= attr_label(:user, :phone) %></legend>
        <%= f.input_field :phone, class: 'input input-bordered w-full' %>
      </fieldset>
    </div>
  </div>

  <%# Password %>
  <div class="card bg-base-100 border border-base-300 shadow-sm">
    <div class="card-body p-6">
      <%= render Admin::SectionHeaderComponent.new(
        title: "Password",
        description: "Leave blank to keep your current password.",
        margin: 4
      ) %>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <fieldset class="fieldset">
          <legend class="fieldset-legend">New Password</legend>
          <%= f.input_field :password, type: :password, class: 'input input-bordered w-full', autocomplete: "new-password" %>
          <% if @minimum_password_length %>
            <p class="fieldset-label"><%= @minimum_password_length %> characters minimum</p>
          <% end %>
        </fieldset>

        <fieldset class="fieldset">
          <legend class="fieldset-legend">Confirm New Password</legend>
          <%= f.input_field :password_confirmation, type: :password, class: 'input input-bordered w-full', autocomplete: "new-password" %>
        </fieldset>
      </div>

      <fieldset class="fieldset">
        <legend class="fieldset-legend">Current Password <span class="text-error">*</span></legend>
        <%= f.input_field :current_password, type: :password, class: 'input input-bordered w-full', autocomplete: "current-password" %>
        <p class="fieldset-label">Required to save any changes.</p>
      </fieldset>
    </div>
  </div>

  <%# Your Permissions %>
  <% if current_user.partners.any? || current_user.neighbourhoods.any? || current_user.partnership_admin? || current_user.root? %>
    <div class="card bg-base-100 border border-base-300 shadow-sm">
      <div class="card-body p-6">
        <%= render Admin::SectionHeaderComponent.new(
          title: "Your Permissions",
          description: "Resources you can access and manage.",
          margin: 4
        ) %>

        <% if current_user.root? %>
          <div role="alert" class="alert bg-amber-50 border-amber-200 text-amber-800">
            <%= icon(:crown, size: '5', css_class: 'text-amber-500') %>
            <span>You are a <strong>root</strong> user and can access everything.</span>
          </div>
        <% elsif user_has_no_rights?(current_user) %>
          <div role="alert" class="alert alert-warning no-admin-rights">
            <%= icon(:warning, size: '5') %>
            <span>You have no admin rights. Please contact whoever invited you to set up your account correctly.</span>
          </div>
        <% else %>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <%# Partners %>
            <% if current_user.partners.any? %>
              <div class="bg-base-200/50 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-3">
                  <div class="w-8 h-8 rounded-lg bg-emerald-100 flex items-center justify-center">
                    <%= icon(:partner, size: '4', css_class: 'text-emerald-600') %>
                  </div>
                  <h4 class="font-medium"><%= t('admin.users.profile.your_partners') %></h4>
                </div>
                <%= render Admin::ItemBadgeListComponent.new(
                  items: current_user.partners.order(:name),
                  icon_name: :partner,
                  icon_color: "bg-emerald-100 text-emerald-600",
                  link_path: :edit_admin_partner_path,
                  empty_text: t('admin.empty.none_assigned', items: Partner.model_name.human(count: 2).downcase)
                ) %>
              </div>
            <% end %>

            <%# Neighbourhoods %>
            <% if current_user.neighbourhoods.any? %>
              <div class="bg-base-200/50 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-3">
                  <div class="w-8 h-8 rounded-lg bg-sky-100 flex items-center justify-center">
                    <%= icon(:map_pin, size: '4', css_class: 'text-sky-600') %>
                  </div>
                  <h4 class="font-medium"><%= t('admin.users.profile.your_neighbourhoods') %></h4>
                </div>
                <%= render Admin::ItemBadgeListComponent.new(
                  items: current_user.neighbourhoods.order(:name),
                  icon_name: :map_pin,
                  icon_color: "bg-sky-100 text-sky-600",
                  link_path: :edit_admin_neighbourhood_path,
                  empty_text: t('admin.empty.none_assigned', items: Neighbourhood.model_name.human(count: 2).downcase)
                ) %>
              </div>
            <% end %>

            <%# Partnerships/Tags %>
            <% if current_user.partnership_admin? %>
              <div class="bg-base-200/50 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-3">
                  <div class="w-8 h-8 rounded-lg bg-amber-100 flex items-center justify-center">
                    <%= icon(:partnership, size: '4', css_class: 'text-amber-600') %>
                  </div>
                  <h4 class="font-medium"><%= t('admin.users.profile.your_partnerships') %></h4>
                </div>
                <p class="text-sm text-base-content/60 mb-2"><%= t('admin.users.profile.partnerships_hint') %></p>
                <%= render Admin::ItemBadgeListComponent.new(
                  items: current_user.tags.order(:name),
                  icon_name: :partnership,
                  icon_color: "bg-amber-100 text-amber-600",
                  link_path: :edit_admin_tag_path,
                  empty_text: t('admin.empty.none_assigned', items: Partnership.model_name.human(count: 2).downcase)
                ) %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <%= render Admin::SaveBarComponent.new do |c| %>
    <% c.with_button do %>
      <%= f.submit "Update Profile", class: "btn bg-placecal-orange hover:bg-orange-600 text-white border-placecal-orange" %>
    <% end %>
  <% end %>
<% end %>
