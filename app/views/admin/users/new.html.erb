<% content_for :title do %>New User<% end %>

<div class="mb-6">
  <h1 class="text-2xl font-semibold">New User</h1>
  <p class="text-gray-600 mt-1">Invite a new user to PlaceCal.</p>
</div>

<%- display_fields = policy(@current_user).permitted_attributes_for_create %>

<%= filtered_form_for([:admin, @user],
                      display_only: display_fields,
                      html: { class: 'space-y-6', data: { controller: 'live-validation' } }) do |f| %>

  <%= render(Admin::ErrorComponent.new(@user)) %>

  <div class="card bg-base-100 border border-base-300 shadow-sm">
    <div class="card-body p-6">
      <%= render Admin::SectionHeaderComponent.new(
        title: t('admin.users.sections.personal_details'),
        description: "Enter the basic information for this user.",
        margin: 4
      ) %>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <fieldset class="fieldset">
          <legend class="fieldset-legend"><%= attr_label(:user, :first_name) %></legend>
          <%= f.input_field :first_name, class: 'input input-bordered w-full' %>
        </fieldset>

        <fieldset class="fieldset">
          <legend class="fieldset-legend"><%= attr_label(:user, :last_name) %></legend>
          <%= f.input_field :last_name, class: 'input input-bordered w-full' %>
        </fieldset>
      </div>

      <fieldset class="fieldset">
        <legend class="fieldset-legend"><%= attr_label(:user, :email) %> <span class="text-error"><%= t('admin.labels.required') %></span></legend>
        <%= f.input_field :email, class: 'input input-bordered w-full' %>
        <p class="fieldset-label">An invitation email will be sent to this address.</p>
      </fieldset>

      <fieldset class="fieldset">
        <legend class="fieldset-legend"><%= attr_label(:user, :phone) %></legend>
        <%= f.input_field :phone, class: 'input input-bordered w-full' %>
      </fieldset>
    </div>
  </div>

  <%# Partners Section %>
  <div class="card bg-base-100 border border-base-300 shadow-sm">
    <div class="card-body p-6">
      <div class="flex items-start gap-4 mb-4">
        <div class="shrink-0 w-11 h-11 rounded-xl bg-linear-to-br from-emerald-100 to-teal-100 flex items-center justify-center shadow-sm">
          <%= icon(:partner, size: '6', css_class: 'text-emerald-600') %>
        </div>
        <div>
          <h3 class="card-title text-lg"><%= Partner.model_name.human(count: 2) %></h3>
          <p class="text-sm text-gray-600 mt-0.5"><%= t('admin.users.fields.partners_hint') %></p>
        </div>
      </div>

      <%= render Admin::StackedListSelectorComponent.new(
        field_name: "user[partner_ids][]",
        items: @user.partners.order(:name),
        options: options_for_partners(@user),
        permitted_ids: permitted_options_for_partners,
        icon_name: :partner,
        icon_color: "bg-emerald-100 text-emerald-600",
        empty_text: t('admin.empty.none_assigned', items: Partner.model_name.human(count: 2).downcase),
        add_placeholder: t('admin.placeholders.add_model', model: Partner.model_name.human.downcase),
        use_tom_select: true,
        wrapper_class: "user_partners"
      ) %>
    </div>
  </div>

  <%# Neighbourhoods Section - only for root users %>
  <% if current_user.root? %>
    <div class="card bg-base-100 border border-base-300 shadow-sm">
      <div class="card-body p-6">
        <div class="flex items-start gap-4 mb-4">
          <div class="shrink-0 w-11 h-11 rounded-xl bg-linear-to-br from-sky-100 to-blue-100 flex items-center justify-center shadow-sm">
            <%= icon(:map_pin, size: '6', css_class: 'text-sky-600') %>
          </div>
          <div>
            <h3 class="card-title text-lg"><%= Neighbourhood.model_name.human(count: 2) %></h3>
            <p class="text-sm text-gray-600 mt-0.5"><%= t('admin.users.fields.neighbourhoods_hint_root') %></p>
          </div>
        </div>

        <%= render Admin::StackedListSelectorComponent.new(
          field_name: "user[neighbourhood_ids][]",
          items: @user.neighbourhoods.order(:name),
          options: options_for_user_neighbourhoods(@user),
          permitted_ids: nil,
          icon_name: :map_pin,
          icon_color: "bg-sky-100 text-sky-600",
          empty_text: t('admin.empty.none_assigned', items: Neighbourhood.model_name.human(count: 2).downcase),
          add_placeholder: t('admin.placeholders.add_model', model: Neighbourhood.model_name.human.downcase),
          use_tom_select: true,
          wrapper_class: "user_neighbourhoods"
        ) %>
      </div>
    </div>

    <%# Role Section - only for root users %>
    <div class="card bg-base-100 border border-base-300 shadow-sm">
      <div class="card-body p-6">
        <%= render Admin::SectionHeaderComponent.new(
          title: attr_label(:user, :role),
          description: t('admin.users.fields.role_hint'),
          margin: 4
        ) %>

        <%= render Admin::RadioCardGroupComponent.new(
          form: f,
          attribute: :role,
          values: User.role.values,
          i18n_scope: 'admin.users.roles'
        ) %>
      </div>
    </div>
  <% end %>

  <div role="alert" class="alert bg-blue-50 border-blue-200 text-blue-800">
    <%= icon(:info, size: '5', css_class: 'text-blue-500') %>
    <span>Inviting a user will require their acceptance of the PlaceCal <%= link_to 'Terms of Use', terms_of_use_path, class: 'link link-hover text-placecal-teal font-medium' %>.</span>
  </div>

  <%= render Admin::SaveBarComponent.new do |c| %>
    <% c.with_button do %>
      <%= f.submit t('admin.users.actions.invite'), class: "btn bg-placecal-orange hover:bg-orange-600 text-white border-placecal-orange" %>
    <% end %>
  <% end %>
<% end %>
