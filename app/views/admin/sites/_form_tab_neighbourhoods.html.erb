<%= render Admin::SectionHeaderComponent.new(
  title: Neighbourhood.model_name.human(count: 2),
  description: t('admin.sites.sections.neighbourhoods_description')
) %>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
  <fieldset class="fieldset bg-base-200/50 border border-base-300 rounded-box p-4">
    <legend class="fieldset-legend"><%= t('admin.sites.sections.main_neighbourhood') %></legend>
    <p class="text-sm text-base-content/60 mb-4"><%= t('admin.sites.sections.main_neighbourhood_description') %></p>

    <%= f.simple_fields_for :sites_neighbourhood do |sn| %>
      <% primary_neighbourhood = (@all_neighbourhoods.where(id: @primary_neighbourhood_id).first if @primary_neighbourhood_id.present?) %>
      <% if primary_neighbourhood.present? %>
        <div class="mb-3">
          <span class="badge badge-lg badge-neutral gap-2">
            <%= icon(:map_pin, size: '4') %>
            <%= primary_neighbourhood.contextual_name %>
            <% if primary_neighbourhood.legacy_neighbourhood? %>
              (<%= primary_neighbourhood.release_date.year %>/<%= primary_neighbourhood.release_date.month %>)
            <% end %>
          </span>
        </div>
        <%= sn.hidden_field :relation_type, value: "Primary" %>
        <%= sn.hidden_field :neighbourhood_id, value: primary_neighbourhood.id %>
        <% if primary_neighbourhood.legacy_neighbourhood? %>
          <div role="alert" class="alert alert-warning py-2">
            <%= icon(:warning, size: '5', css_class: 'shrink-0 stroke-current') %>
            <span class="text-sm"><%= t('admin.sites.neighbourhoods.legacy_warning') %></span>
          </div>
        <% end %>
      <% else %>
        <%= sn.hidden_field :relation_type, value: "Primary" %>
        <div class="site_sites_neighbourhood_neighbourhood_id">
          <%= sn.input :neighbourhood_id, collection: options_for_sites_neighbourhoods(@site), include_blank: false,
              value_method: ->(obj) { obj[:id] }, label_method: ->(obj) { obj[:name] },
              input_html: { data: { controller: "tom-select" }, class: 'select select-bordered w-full bg-base-100' },
              label: '', label_html: { hidden: true }, wrapper: false %>
        </div>
      <% end %>
    <% end %>
  </fieldset>

  <fieldset class="fieldset bg-base-200/50 border border-base-300 rounded-box p-4">
    <legend class="fieldset-legend"><%= t('admin.sites.sections.display_level') %></legend>
    <p class="text-sm text-base-content/60 mb-4"><%= t('admin.sites.sections.display_level_description') %></p>

    <%= render Admin::RadioCardGroupComponent.new(
      form: f,
      attribute: :badge_zoom_level,
      values: Site.badge_zoom_level.values
    ) %>
  </fieldset>
</div>

<div class="mt-8">
  <h3 class="font-semibold mb-2"><%= t('admin.sites.sections.other_neighbourhoods') %></h3>
  <p class="text-sm text-base-content/60 mb-4"><%= t('admin.sites.sections.other_neighbourhoods_description') %></p>

  <% if policy(@site).permitted_attributes.include? :sites_neighbourhoods %>
    <div class="space-y-2">
      <%= nested_form_for(f, :sites_neighbourhoods,
            add_text: t('admin.actions.add_model', model: Neighbourhood.model_name.human.downcase),
            add_class: 'btn btn-sm bg-placecal-orange hover:bg-orange-600 text-white border-placecal-orange',
            partial: 'sites_neighbourhood_fields') do %>
        <%= f.simple_fields_for :sites_neighbourhoods do |neighbourhood| %>
          <%= render 'sites_neighbourhood_fields', f: neighbourhood %>
        <% end %>
      <% end %>
    </div>
  <% else %>
    <% secondary_neighbourhoods = @site.sites_neighbourhoods.select { |n| n.relation_type != 'Primary' } %>
    <% if secondary_neighbourhoods.any? %>
      <div class="flex flex-wrap gap-2">
        <% secondary_neighbourhoods.each do |neighbourhood| %>
          <span class="badge badge-outline"><%= neighbourhood.name %></span>
        <% end %>
      </div>
    <% else %>
      <p class="text-sm text-base-content/50 italic"><%= t('admin.empty.no_items', items: Neighbourhood.model_name.human(count: 2).downcase) %></p>
    <% end %>
  <% end %>
</div>
