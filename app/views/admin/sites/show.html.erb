<%# Site Show - Calendars displayed on this site %>

<div class="mb-6">
  <div class="flex flex-wrap items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold"><%= @site.name %></h1>
      <p class="text-sm text-gray-600 mt-1">
        <%= t('admin.sites.show.title') %>
      </p>
    </div>
    <div class="flex items-center gap-2">
      <%= link_to edit_admin_site_path(@site), class: "btn bg-placecal-orange hover:bg-orange-600 text-white border-placecal-orange" do %>
        <%= icon(:edit, size: '4') %>
        <%= t('admin.sites.show.edit_site') %>
      <% end %>
    </div>
  </div>
</div>

<% error_count = @calendars.where(calendar_state: [:error, :bad_source]).count %>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
  <%= render Admin::InfoCardComponent.new(
    icon: :calendar,
    label: Calendar.model_name.human(count: 2),
    value: @calendars.count,
    color: :orange
  ) %>

  <%= render Admin::InfoCardComponent.new(
    icon: :check,
    label: t('admin.labels.healthy'),
    value: @calendars.where(calendar_state: :idle).count,
    color: :success
  ) %>

  <%= render Admin::InfoCardComponent.new(
    icon: :warning,
    label: t('admin.labels.issues'),
    value: error_count,
    color: error_count > 0 ? :error : :neutral
  ) %>
</div>

<%# Calendars Table %>
<div class="card bg-base-100 border border-base-300">
  <div class="card-body p-0">
    <div class="p-4 border-b border-base-300 flex items-center justify-between">
      <h2 class="font-bold flex items-center gap-2">
        <%= icon(:calendar, size: '5') %>
        Calendars
        <span class="badge badge-neutral"><%= @calendars.count %></span>
      </h2>
    </div>

    <% if @calendars.any? %>
      <div class="overflow-x-auto">
        <table class="table table-sm">
          <thead>
            <tr>
              <th><%= t('admin.table.name') %></th>
              <th><%= t('admin.table.state') %></th>
              <th><%= t('admin.table.last_import') %></th>
              <th><%= t('admin.table.last_changed') %></th>
            </tr>
          </thead>
          <tbody>
            <% @calendars.each do |calendar| %>
              <tr class="hover">
                <td>
                  <div class="flex flex-col">
                    <%= link_to calendar.name, edit_admin_calendar_path(calendar), class: "font-medium text-base-content hover:text-placecal-orange" %>
                    <span class="text-xs text-gray-600 font-mono">#<%= calendar.id %></span>
                  </div>
                </td>
                <td>
                  <% case calendar.calendar_state.to_s %>
                  <% when 'idle' %>
                    <span class="inline-flex items-center gap-1 text-success" title="Ready">
                      <%= icon(:check, size: '4') %>
                    </span>
                  <% when 'in_queue', 'in_worker' %>
                    <span class="inline-flex items-center gap-1 text-info" title="Processing">
                      <%= icon(:swap, size: '4', css_class: 'animate-spin') %>
                    </span>
                  <% when 'error', 'bad_source' %>
                    <span class="inline-flex items-center gap-1 text-error" title="<%= calendar.calendar_state.to_s.titleize %>">
                      <%= icon(:warning, size: '4') %>
                    </span>
                  <% else %>
                    <span class="text-gray-500">—</span>
                  <% end %>
                </td>
                <td class="whitespace-nowrap">
                  <% if calendar.last_import_at %>
                    <span class="text-sm text-base-content/70" title="<%= calendar.last_import_at.strftime('%d %b %Y at %H:%M') %>">
                      <%= time_ago_in_words(calendar.last_import_at) %> ago
                    </span>
                  <% else %>
                    <span class="text-gray-500">—</span>
                  <% end %>
                </td>
                <td class="whitespace-nowrap">
                  <% if calendar.checksum_updated_at %>
                    <span class="text-sm text-base-content/70" title="<%= calendar.checksum_updated_at.strftime('%d %b %Y at %H:%M') %>">
                      <%= time_ago_in_words(calendar.checksum_updated_at) %> ago
                    </span>
                  <% else %>
                    <span class="text-gray-500">—</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <%= render Admin::EmptyStateComponent.new(
        icon: :calendar,
        message: t('admin.sites.show.empty.title'),
        hint: t('admin.sites.show.empty.hint'),
        icon_size: '12',
        padding: 'py-12'
      ) %>
    <% end %>
  </div>
</div>
