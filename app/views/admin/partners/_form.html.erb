<%= simple_form_for @partner, html: { data: { controller: 'partner-tabs live-validation' } } do |f| %>

  <% unless policy(@partner).permitted_attributes.include? :hidden %>
    <% if @partner.hidden %>
      <div role="alert" class="alert alert-error mb-6">
        <%= icon(:warning, size: '6', css_class: 'shrink-0') %>
        <div>
          <h3 class="font-bold">This partner is hidden</h3>
          <p>Your partner is currently not visible to the public for the following reason:</p>
          <div class="mt-2 p-3 bg-error/20 rounded"><%= @partner.hidden_reason_html.to_s.html_safe %></div>
          <p class="mt-2">Once you have fixed this issue, contact <a href="mailto:support@placecal.org" class="link">support@placecal.org</a> to make your partner public again.</p>
        </div>
      </div>
    <% end %>
  <% end %>

  <%# Radio Tabs - daisyUI tabs-lift %>
  <div role="tablist" class="tabs tabs-lift">
    <input type="radio" name="partner_tabs" class="tab" aria-label="ðŸ“‹ Basic Info" data-partner-tabs-target="tab" data-hash="basic" checked="checked" />
    <div class="tab-content bg-base-100 border-base-300 p-6" data-partner-tabs-target="panel" data-section="basic">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-4">
          <h2 class="text-lg font-bold mb-1">Basic Information</h2>
          <p class="text-sm text-base-content/60 mb-4">Enter the core details about your partner organisation.</p>

          <fieldset class="fieldset">
            <legend class="fieldset-legend">Partner Name <span class="text-error">*</span></legend>
            <%= f.input_field :name, class: 'input input-bordered w-full',
                'data-controller': "partner-form-validation",
                'data-partner-form-validation-target': 'source',
                'data-action': 'input->partner-form-validation#checkInput',
                'data-validate-required': 'true',
                'data-validate-min': '5',
                'data-validate-required-message': 'Partner name is required',
                'data-validate-min-message': 'Name must be at least 5 characters' %>
          </fieldset>

          <fieldset class="fieldset" data-controller="char-counter" data-char-counter-max-value="200">
            <legend class="fieldset-legend">Summary</legend>
            <%= f.input_field :summary, as: :text, class: 'textarea textarea-bordered w-full min-h-16', maxlength: 200, data: { controller: 'auto-expand', char_counter_target: 'input', action: 'input->char-counter#update' } %>
            <div class="flex items-center justify-between mt-1">
              <p class="fieldset-label">A brief one-line summary</p>
              <span class="text-xs tabular-nums transition-colors" data-char-counter-target="counter">0 / 200</span>
            </div>
          </fieldset>

          <fieldset class="fieldset">
            <legend class="fieldset-legend">Description</legend>
            <%= f.input_field :description, class: 'textarea textarea-bordered w-full min-h-32', data: { controller: 'auto-expand' } %>
            <p class="fieldset-label">Full description of what this partner does</p>
          </fieldset>

          <fieldset class="fieldset">
            <legend class="fieldset-legend">Accessibility Information</legend>
            <%= f.input_field :accessibility_info, class: 'textarea textarea-bordered w-full min-h-20', data: { controller: 'auto-expand' } %>
            <p class="fieldset-label">Details about accessibility features</p>
          </fieldset>
        </div>

        <%# Partner Image - Right column on larger screens %>
        <div class="lg:border-l lg:border-base-300 lg:pl-6">
          <h3 class="font-semibold mb-4 flex items-center gap-2">
            <%= icon(:photo, size: '5', css_class: 'text-placecal-orange') %>
            Partner Image
          </h3>
          <div data-controller="image-preview">
            <%# File Input / Dropzone %>
            <div class="mb-4">
              <div class="relative overflow-hidden rounded-lg border-2 border-dashed border-base-300 hover:border-placecal-orange transition-colors bg-base-200/50 hover:bg-base-200 cursor-pointer"
                   data-image-preview-target="dropzone">
                <label class="flex items-center gap-3 p-3 cursor-pointer">
                  <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-placecal-orange/10 flex items-center justify-center">
                    <%= icon(:upload, size: '5', css_class: 'text-placecal-orange') %>
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-base-content">Choose file or drag here</p>
                    <p class="text-xs text-base-content/50"><%= image_uploader_hint(@partner.image) %></p>
                  </div>
                  <%= f.input_field :image, as: :file, class: 'sr-only', data: { action: "change->image-preview#file", image_preview_target: "input" } %>
                </label>
              </div>
            </div>

            <%# Image Preview %>
            <div class="relative group" data-image-preview-target="wrapper">
              <% if @partner.image.url %>
                <div class="relative rounded-lg overflow-hidden border border-base-300 bg-base-200">
                  <%= image_tag @partner.image.url, class: 'w-full h-auto', data: { image_preview_target: "img" } %>
                  <div class="absolute inset-0 bg-black/0 group-hover:bg-black/40 transition-colors flex items-center justify-center opacity-0 group-hover:opacity-100">
                    <label class="btn btn-sm bg-white/90 hover:bg-white text-base-content border-0 shadow-lg cursor-pointer">
                      <%= icon(:upload, size: '4') %>
                      Replace
                      <%= f.input_field :image, as: :file, class: 'sr-only', data: { action: "change->image-preview#file" } %>
                    </label>
                  </div>
                </div>
                <%# Delete checkbox %>
                <div class="mt-2 flex justify-end">
                  <label class="inline-flex items-center gap-2 text-xs text-error cursor-pointer hover:text-red-700 transition-colors has-[:checked]:line-through has-[:checked]:opacity-60">
                    <%= f.check_box :remove_image, class: 'sr-only' %>
                    <%= icon(:trash, size: '3.5') %>
                    Remove image on save
                  </label>
                </div>
              <% else %>
                <div class="aspect-square rounded-lg border border-base-300 bg-base-200/50 flex items-center justify-center" data-image-preview-target="placeholder">
                  <div class="text-center text-base-content/30 p-4">
                    <%= icon(:photo, size: '16', css_class: 'mx-auto mb-3 opacity-50', stroke_width: '1') %>
                    <p class="text-sm font-medium">No image uploaded</p>
                    <p class="text-xs mt-1">Upload an image above</p>
                  </div>
                </div>
                <%= image_tag "", style: 'display:none;', class: 'w-full h-auto rounded-lg border border-base-300', data: { image_preview_target: "img" } %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <input type="radio" name="partner_tabs" class="tab" aria-label="ðŸ“ Location" data-partner-tabs-target="tab" data-hash="location" />
    <div class="tab-content bg-base-100 border-base-300 p-6" data-partner-tabs-target="panel" data-section="location">
      <h2 class="text-lg font-bold mb-1">Location</h2>
      <p class="text-sm text-base-content/60 mb-6">Partners need at least one place - either a fixed address or a service area.</p>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <fieldset class="fieldset bg-base-200 border-base-300 rounded-box border p-4">
          <legend class="fieldset-legend">Address</legend>
          <%= render 'address_fields', form: f, partner: @partner %>
          <% if @partner&.address&.neighbourhood&.legacy_neighbourhood? %>
            <div role="alert" class="alert alert-warning mt-4 text-sm">
              <%= icon(:warning, size: '5', css_class: 'shrink-0') %>
              <span>Outdated neighbourhood. Contact <a href="mailto:support@placecal.org" class="link">support</a> to reassign.</span>
            </div>
          <% end %>
          <% if partner_has_unmappable_postcode?(@partner) %>
            <div role="alert" class="alert alert-warning mt-4 text-sm">
              <%= icon(:warning, size: '5', css_class: 'shrink-0') %>
              <span>Postcode not in our system yet.</span>
            </div>
          <% end %>
        </fieldset>

        <fieldset class="fieldset bg-base-200 border-base-300 rounded-box border p-4">
          <legend class="fieldset-legend">Service Areas</legend>
          <p class="text-sm text-base-content/60 mb-4">If this partner delivers services outside their address. <br><br>Be as specific as possible: wards will show up in searches for regions and gives people more context to go on.</p>
          <%= nested_form_for(f, :service_areas, add_text: 'Add Service Area', add_class: 'btn btn-sm bg-placecal-orange hover:bg-orange-600 text-white border-placecal-orange', partial: 'service_area_fields') do %>
            <%= f.simple_fields_for :service_areas do |neighbourhood| %>
              <%= render 'service_area_fields', f: neighbourhood %>
            <% end %>
          <% end %>
        </fieldset>
      </div>

      <fieldset class="fieldset bg-base-200 border-base-300 rounded-box border p-4 mt-8">
        <legend class="fieldset-legend">Opening Times</legend>
        <%= render 'opening_times', f: f %>
      </fieldset>
    </div>

    <input type="radio" name="partner_tabs" class="tab" aria-label="ðŸ“ž Contact" data-partner-tabs-target="tab" data-hash="contact" />
    <div class="tab-content bg-base-100 border-base-300 p-6" data-partner-tabs-target="panel" data-section="contact">
      <div class="space-y-6">
        <%# Online Presence - Full Width Card %>
        <div class="card bg-base-200/50 border border-base-300">
          <div class="card-body p-4 gap-3">
            <h3 class="font-semibold flex items-center gap-2">
              <%= icon(:desktop, size: '4') %>
              Online Presence
            </h3>
            <p class="text-xs text-base-content/60">Website and social media links.</p>

            <fieldset class="fieldset">
              <legend class="fieldset-legend">Website</legend>
              <%= f.input_field :url, class: 'input input-bordered w-full bg-base-100', placeholder: 'https://your-website.org',
                  'data-validate-url': 'true',
                  'data-validate-url-message': 'Enter a valid URL (including https://)' %>
            </fieldset>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <fieldset class="fieldset">
                <legend class="fieldset-legend">Facebook</legend>
                <label class="input input-bordered flex items-center gap-1 pr-1 bg-base-100">
                  <span class="text-base-content/50 text-sm shrink-0">facebook.com/</span>
                  <%= f.input_field :facebook_link, class: 'grow bg-transparent border-0 focus:outline-none min-w-0' %>
                </label>
              </fieldset>
              <fieldset class="fieldset">
                <legend class="fieldset-legend">X (Twitter)</legend>
                <label class="input input-bordered flex items-center gap-1 bg-base-100">
                  <span class="text-base-content/50">@</span>
                  <%= f.input_field :twitter_handle, class: 'grow bg-transparent border-0 focus:outline-none min-w-0' %>
                </label>
              </fieldset>
              <fieldset class="fieldset">
                <legend class="fieldset-legend">Instagram</legend>
                <label class="input input-bordered flex items-center gap-1 bg-base-100">
                  <span class="text-base-content/50">@</span>
                  <%= f.input_field :instagram_handle, class: 'grow bg-transparent border-0 focus:outline-none min-w-0' %>
                </label>
              </fieldset>
            </div>
          </div>
        </div>

        <%# Contact Details - Two Column Row %>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <%# Public Contact Card %>
          <div class="card bg-base-200/50 border border-base-300">
            <div class="card-body p-4 gap-3">
              <h3 class="font-semibold flex items-center gap-2">
                <%= icon(:website, size: '4') %>
                Public Contact
              </h3>
              <p class="text-xs text-base-content/60">Shown on PlaceCal to the public.</p>
              <fieldset class="fieldset">
                <legend class="fieldset-legend">Name</legend>
                <%= f.input_field :public_name, class: 'input input-bordered w-full bg-base-100' %>
              </fieldset>
              <fieldset class="fieldset">
                <legend class="fieldset-legend">Email</legend>
                <%= f.input_field :public_email, class: 'input input-bordered w-full bg-base-100',
                    'data-validate-email': 'true',
                    'data-validate-email-message': 'Enter a valid email address' %>
              </fieldset>
              <fieldset class="fieldset">
                <legend class="fieldset-legend">Phone</legend>
                <%= f.input_field :public_phone, class: 'input input-bordered w-full bg-base-100' %>
              </fieldset>
            </div>
          </div>

          <%# Partnership Contact Card %>
          <div class="card bg-base-200/50 border border-base-300">
            <div class="card-body p-4 gap-3">
              <h3 class="font-semibold flex items-center gap-2">
                <%= icon(:partnership, size: '4') %>
                Partnership Contact
              </h3>
              <p class="text-xs text-base-content/60">Internal contact for PlaceCal team. Leave blank to use public contact.</p>
              <fieldset class="fieldset">
                <legend class="fieldset-legend">Name</legend>
                <%= f.input_field :partner_name, class: 'input input-bordered w-full bg-base-100 placeholder:text-base-content/30', placeholder: @partner.public_name %>
              </fieldset>
              <fieldset class="fieldset">
                <legend class="fieldset-legend">Email</legend>
                <%= f.input_field :partner_email, class: 'input input-bordered w-full bg-base-100 placeholder:text-base-content/30', placeholder: @partner.public_email,
                    'data-validate-email': 'true',
                    'data-validate-email-message': 'Enter a valid email address' %>
              </fieldset>
              <fieldset class="fieldset">
                <legend class="fieldset-legend">Phone</legend>
                <%= f.input_field :partner_phone, class: 'input input-bordered w-full bg-base-100 placeholder:text-base-content/30', placeholder: @partner.public_phone %>
              </fieldset>
            </div>
          </div>
        </div>
      </div>
    </div>

    <input type="radio" name="partner_tabs" class="tab" aria-label="ðŸ·ï¸ Tags" data-partner-tabs-target="tab" data-hash="tags" />
    <div class="tab-content bg-base-100 border-base-300 p-6" data-partner-tabs-target="panel" data-section="tags">
      <h2 class="text-lg font-bold mb-1">Tags & Associations</h2>
      <p class="text-sm text-base-content/60 mb-6">Categorise this partner and link to partnerships.</p>

      <div class="space-y-6 max-w-2xl">
        <%= render 'partnership_fields', f: f %>

        <fieldset class="fieldset">
          <legend class="fieldset-legend">Facilities</legend>
          <p class="fieldset-label mb-3">What infrastructure does this partner provide?</p>
          <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-x-6 gap-y-2">
            <% Facility.all.each do |facility| %>
              <label class="label cursor-pointer gap-2 justify-start py-1">
                <%= check_box_tag "partner[facility_ids][]", facility.id, @partner.facilities.include?(facility), class: 'checkbox checkbox-sm checkbox-warning', id: "facility_#{facility.id}" %>
                <span class="label-text text-sm"><%= facility.name %></span>
              </label>
            <% end %>
          </div>
          <%= hidden_field_tag "partner[facility_ids][]", "" %>
        </fieldset>

        <fieldset class="fieldset" data-controller="checkbox-limit" data-checkbox-limit-max-value="<%= Partner::MAX_CATEGORIES %>">
          <legend class="fieldset-legend">Categories</legend>
          <p class="fieldset-label mb-3">
            Partners may have up to <%= Partner::MAX_CATEGORIES %> category tags
            <span class="badge badge-sm badge-ghost ml-2" data-counter>0 / <%= Partner::MAX_CATEGORIES %></span>
          </p>
          <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-x-6 gap-y-2">
            <% Category.all.each do |category| %>
              <label class="label cursor-pointer gap-2 justify-start py-1 transition-opacity">
                <%= check_box_tag "partner[category_ids][]", category.id, @partner.categories.include?(category), class: 'checkbox checkbox-sm checkbox-warning', id: "category_#{category.id}" %>
                <span class="label-text text-sm"><%= category.name %></span>
              </label>
            <% end %>
          </div>
          <%= hidden_field_tag "partner[category_ids][]", "" %>
        </fieldset>
      </div>
    </div>

    <% unless @partner.new_record? %>
      <input type="radio" name="partner_tabs" class="tab" aria-label="ðŸ“… Calendars" data-partner-tabs-target="tab" data-hash="calendars" />
      <div class="tab-content bg-base-100 border-base-300 p-6" data-partner-tabs-target="panel" data-section="calendars">
        <h2 class="text-lg font-bold mb-1 flex items-center gap-2">
          <%= icon(:calendar, size: '5') %>
          Calendars
          <span class="badge badge-neutral"><%= @partner.calendars.count %></span>
        </h2>
        <p class="text-sm text-base-content/60 mb-6">Event sources connected to this partner.</p>

        <% if @partner.calendars.any? %>
          <div class="grid gap-3 max-w-2xl">
            <% @partner.calendars.each do |calendar| %>
              <div class="card card-compact bg-base-200/50 border border-base-300">
                <div class="card-body flex-row items-center justify-between">
                  <div>
                    <h3 class="font-medium"><%= calendar.name %></h3>
                    <p class="text-xs text-base-content/60"><%= calendar.source %></p>
                  </div>
                  <%= link_to "Edit", edit_admin_calendar_path(calendar), class: "btn btn-ghost btn-sm" %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-center py-12">
            <%= icon(:calendar, size: '12', css_class: 'mx-auto text-base-content/30', stroke_width: '1.5') %>
            <p class="mt-2 text-base-content/60">No calendars connected yet</p>
          </div>
        <% end %>

        <div class="mt-6">
          <%= link_to new_admin_calendar_path(partner_id: @partner.id), class: "btn btn-sm bg-placecal-orange hover:bg-orange-600 text-white border-placecal-orange" do %>
            <%= icon(:plus, size: '4') %>
            Add Calendar
          <% end %>
        </div>
      </div>

      <input type="radio" name="partner_tabs" class="tab" aria-label="ðŸ‘¥ Admins" data-partner-tabs-target="tab" data-hash="admins" />
      <div class="tab-content bg-base-100 border-base-300 p-6" data-partner-tabs-target="panel" data-section="admins">
        <h2 class="text-lg font-bold mb-1 flex items-center gap-2">
          <%= icon(:user_add, size: '5') %>
          Admins
          <span class="badge badge-neutral"><%= @partner.users.count %></span>
        </h2>
        <p class="text-sm text-base-content/60 mb-6">Users who can manage this partner.</p>

        <% if @partner.users.any? %>
          <div class="grid gap-3 max-w-2xl">
            <% @partner.users.each do |p_user| %>
              <div class="card card-compact bg-base-200/50 border border-base-300">
                <div class="card-body flex-row items-center justify-between">
                  <div>
                    <h3 class="font-medium"><%= p_user.email %></h3>
                    <p class="text-xs text-base-content/60">Added <%= time_ago_in_words(p_user.created_at) %> ago</p>
                  </div>
                  <% if policy(User).update? %>
                    <%= link_to "Edit", edit_admin_user_path(p_user), class: "btn btn-ghost btn-sm" %>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-center py-12">
            <%= icon(:user_add, size: '12', css_class: 'mx-auto text-base-content/30', stroke_width: '1.5') %>
            <p class="mt-2 text-base-content/60">No admins assigned yet</p>
          </div>
        <% end %>

        <% if policy(User).update? %>
          <div class="mt-6">
            <%= link_to new_admin_user_path(partner_id: @partner.id), class: "btn btn-sm bg-placecal-orange hover:bg-orange-600 text-white border-placecal-orange" do %>
              <%= icon(:plus, size: '4') %>
              Add Admin
            <% end %>
          </div>
        <% end %>
      </div>

      <input type="radio" name="partner_tabs" class="tab" aria-label="ðŸ‘ï¸ Preview" data-partner-tabs-target="tab" data-hash="preview" />
      <div class="tab-content bg-base-100 border-base-300 p-6" data-partner-tabs-target="panel" data-section="preview">
        <h2 class="text-lg font-bold mb-1">Live Site Preview</h2>
        <p class="text-sm text-base-content/60 mb-6">How this partner appears on PlaceCal.</p>

        <div class="mockup-browser bg-base-300 border border-base-300 max-w-4xl">
          <div class="mockup-browser-toolbar">
            <div class="input text-sm">placecal.org/partners/<%= @partner.slug %></div>
          </div>
          <div class="bg-base-100">
            <%# Partner Header %>
            <div class="bg-neutral text-neutral-content p-6">
              <h1 class="text-2xl font-bold"><%= @partner.name %></h1>
              <% if @partner.summary.present? %>
                <p class="mt-2 text-neutral-content/80"><%= @partner.summary %></p>
              <% end %>
            </div>

            <div class="p-6">
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                  <% if @partner.description_html.present? %>
                    <div class="prose prose-sm max-w-none">
                      <%= @partner.description_html.to_s.html_safe %>
                    </div>
                  <% else %>
                    <p class="text-base-content/50 italic">No description provided.</p>
                  <% end %>

                  <% if @partner.accessibility_info.present? %>
                    <div class="mt-6">
                      <h3 class="font-semibold mb-2">Accessibility</h3>
                      <p class="text-sm"><%= @partner.accessibility_info %></p>
                    </div>
                  <% end %>
                </div>

                <div class="space-y-4">
                  <% if @partner.image.present? %>
                    <%= image_tag @partner.image.standard.url, class: 'rounded-box w-full' %>
                  <% else %>
                    <div class="bg-base-200 rounded-box aspect-square flex items-center justify-center">
                      <span class="text-base-content/30 text-sm">No image</span>
                    </div>
                  <% end %>

                  <div class="card bg-base-200 card-body p-4 text-sm">
                    <% if @partner.address&.to_s.present? %>
                      <div class="mb-3">
                        <div class="font-semibold text-xs uppercase text-base-content/60 mb-1">Address</div>
                        <p><%= @partner.address %></p>
                      </div>
                    <% end %>

                    <% if @partner.url.present? %>
                      <div class="mb-3">
                        <div class="font-semibold text-xs uppercase text-base-content/60 mb-1">Website</div>
                        <%= link_to @partner.url, @partner.url, target: '_blank', class: 'link text-placecal-orange hover:text-orange-600 break-all' %>
                      </div>
                    <% end %>

                    <% if @partner.public_email.present? %>
                      <div class="mb-3">
                        <div class="font-semibold text-xs uppercase text-base-content/60 mb-1">Email</div>
                        <%= mail_to @partner.public_email, @partner.public_email, class: 'link text-placecal-orange hover:text-orange-600' %>
                      </div>
                    <% end %>

                    <% if @partner.public_phone.present? %>
                      <div>
                        <div class="font-semibold text-xs uppercase text-base-content/60 mb-1">Phone</div>
                        <p><%= @partner.public_phone %></p>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="divider my-8"></div>

        <h3 class="text-lg font-bold mb-1">Upcoming Events</h3>
        <p class="text-sm text-base-content/60 mb-6">Events in the next 30 days from this partner's calendars.</p>

        <% upcoming_events = @partner.events.upcoming.where(dtstart: ..30.days.from_now).order(:dtstart).limit(20) %>
        <% if upcoming_events.any? %>
          <div class="overflow-x-auto">
            <table class="table table-sm table-zebra">
              <thead>
                <tr>
                  <th>Event</th>
                  <th>Date & Time</th>
                  <th>Calendar</th>
                </tr>
              </thead>
              <tbody>
                <% upcoming_events.each do |event| %>
                  <tr>
                    <td>
                      <div class="font-medium"><%= truncate(event.summary, length: 50) %></div>
                    </td>
                    <td class="whitespace-nowrap text-sm">
                      <%= event.dtstart.strftime('%a %d %b %H:%M') %>
                    </td>
                    <td>
                      <% if event.calendar %>
                        <%= link_to event.calendar.name, edit_admin_calendar_path(event.calendar), class: "link text-placecal-orange hover:text-orange-600 text-sm" %>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="text-center py-8">
            <%= icon(:calendar, size: '10', css_class: 'mx-auto text-base-content/30', stroke_width: '1.5') %>
            <p class="mt-2 text-base-content/60">No upcoming events in the next 30 days</p>
          </div>
        <% end %>
      </div>
    <% end %>

    <%# Spacer to push Settings tab right %>
    <div class="tab flex-1 cursor-default"></div>

    <input type="radio" name="partner_tabs" class="tab" aria-label="âš™ï¸ Settings" data-partner-tabs-target="tab" data-hash="settings" />
    <div class="tab-content bg-base-100 border-base-300 p-6" data-partner-tabs-target="panel" data-section="settings">
      <% if policy(@partner).permitted_attributes.include? :slug %>
        <div class="mb-8">
          <h2 class="text-lg font-bold mb-1">URL Settings</h2>
          <p class="text-sm text-base-content/60 mb-4">Customise the URL slug for this partner.</p>
          <div class="max-w-md">
            <fieldset class="fieldset">
              <legend class="fieldset-legend">URL Slug</legend>
              <%= f.input_field :slug, class: 'input input-bordered w-full' %>
              <p class="fieldset-label">Leave blank to auto-generate from name</p>
            </fieldset>
          </div>
        </div>
      <% end %>

      <div class="mb-8">
        <h2 class="text-lg font-bold mb-4">Event Matching</h2>

        <div class="max-w-2xl">
          <%# Event Matching Toggle Card %>
          <% is_enabled = @partner.can_be_assigned_events %>
          <div class="card bg-base-200/50 border-2 border-base-300">
            <div class="card-body p-5">
              <div class="flex items-start gap-4">
                <%# Icon %>
                <div class="shrink-0 w-12 h-12 rounded-xl bg-base-300 flex items-center justify-center">
                  <%= icon(:swap, size: '6', css_class: 'text-base-content/40') %>
                </div>

                <%# Content %>
                <div class="flex-1 min-w-0">
                  <div class="flex items-center justify-between gap-4 mb-2">
                    <h3 class="font-semibold" id="event-matching-title">
                      <%= is_enabled ? 'Event matching is enabled' : 'Event matching is disabled' %>
                    </h3>
                    <div class="flex items-center gap-3">
                      <span class="label-text text-sm font-medium text-base-content/60">Disabled</span>
                      <%= f.check_box :can_be_assigned_events, class: 'toggle toggle-success', id: 'partner_can_be_assigned_events', onchange: 'updateEventMatchingTitle(this.checked)' %>
                      <span class="label-text text-sm font-medium text-success">Enabled</span>
                    </div>
                  </div>

                  <p class="text-sm text-base-content/70 mb-3">
                    Control whether events from other calendars can be automatically listed at this partner's address.
                  </p>

                  <div class="text-sm text-base-content/70 space-y-2">
                    <p class="font-medium text-base-content/90">When enabled:</p>
                    <ul class="list-none space-y-1.5 ml-0">
                      <li class="flex items-start gap-2">
                        <%= icon(:check, size: '4', css_class: 'text-success shrink-0 mt-0.5') %>
                        <span>Events at this address from any PlaceCal calendar will appear here</span>
                      </li>
                      <li class="flex items-start gap-2">
                        <%= icon(:check, size: '4', css_class: 'text-success shrink-0 mt-0.5') %>
                        <span>Visitors see a complete picture of what's happening at this location</span>
                      </li>
                      <li class="flex items-start gap-2">
                        <%= icon(:info, size: '4', css_class: 'text-info shrink-0 mt-0.5') %>
                        <span>Great for venues, community centres, and shared spaces</span>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <script>
          function updateEventMatchingTitle(isEnabled) {
            const title = document.getElementById('event-matching-title');
            title.textContent = isEnabled ? 'Event matching is enabled' : 'Event matching is disabled';
          }
        </script>
      </div>

      <% unless @partner.new_record? %>
        <% if policy(@partner).permitted_attributes.include? :hidden %>
          <div class="mb-8">
            <h2 class="text-lg font-bold mb-4">Moderation</h2>

            <div class="max-w-2xl" data-controller="inverted-toggle">
              <%# Hidden Toggle Card %>
              <div class="card border-2 transition-colors" data-inverted-toggle-target="card">
                <div class="card-body p-5">
                  <div class="flex items-start gap-4">
                    <%# Icon %>
                    <div class="shrink-0 w-12 h-12 rounded-xl flex items-center justify-center transition-colors" data-inverted-toggle-target="icon">
                      <span data-inverted-toggle-target="iconHidden"><%= icon(:eye_off, size: '6', css_class: 'text-error') %></span>
                      <span data-inverted-toggle-target="iconVisible"><%= icon(:eye, size: '6', css_class: 'text-warning') %></span>
                    </div>

                    <%# Content %>
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center justify-between gap-4 mb-2">
                        <h3 class="font-semibold transition-colors" data-inverted-toggle-target="title" id="partner-visibility-title">
                          <%= @partner.hidden? ? 'Partner is hidden' : 'Partner is visible' %>
                        </h3>
                        <div class="flex items-center gap-3">
                          <span class="label-text text-sm font-medium text-error">Hidden</span>
                          <%= f.hidden_field :hidden, value: @partner.hidden? ? '1' : '0', data: { inverted_toggle_target: 'hidden' } %>
                          <input type="checkbox" id="partner_hidden_toggle" class="toggle toggle-success" data-inverted-toggle-target="checkbox" data-action="change->inverted-toggle#toggle" onchange="updateVisibilityTitle(this.checked)" />
                          <span class="label-text text-sm font-medium text-success">Visible</span>
                        </div>
                      </div>

                      <p class="text-sm text-error/80 mb-3" data-inverted-toggle-target="status">This partner is not visible to the public.</p>

                      <div class="text-sm text-base-content/70 space-y-2">
                        <p class="font-medium text-base-content/90">When a partner is hidden:</p>
                        <ul class="list-none space-y-1.5 ml-0">
                          <li class="flex items-start gap-2">
                            <%= icon(:x, size: '4', css_class: 'text-warning shrink-0 mt-0.5') %>
                            <span>Removed from all PlaceCal sites and search results</span>
                          </li>
                          <li class="flex items-start gap-2">
                            <%= icon(:x, size: '4', css_class: 'text-warning shrink-0 mt-0.5') %>
                            <span>Events from this partner will not appear on any calendars</span>
                          </li>
                          <li class="flex items-start gap-2">
                            <%= icon(:x, size: '4', css_class: 'text-warning shrink-0 mt-0.5') %>
                            <span>The partner page will return a 404 error to visitors</span>
                          </li>
                          <li class="flex items-start gap-2">
                            <%= icon(:check, size: '4', css_class: 'text-info shrink-0 mt-0.5') %>
                            <span>Admins can still access and edit the partner in this dashboard</span>
                          </li>
                          <li class="flex items-start gap-2">
                            <%= icon(:bell, size: '4', css_class: 'text-info shrink-0 mt-0.5') %>
                            <span>PlaceCal moderators and the partner admins will be notified</span>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <%# Reason field - shown when hidden or always for entering reason %>
                  <div class="mt-4 pt-4 border-t border-base-300/50">
                    <fieldset class="fieldset">
                      <legend class="fieldset-legend">Reason for hiding</legend>
                      <p class="text-xs text-base-content/60 mb-2">This message will be shown to partner admins explaining why their listing was hidden.</p>
                      <%= f.input_field :hidden_reason, class: 'textarea textarea-bordered w-full min-h-20 bg-base-100', placeholder: 'e.g., Incomplete information, duplicate listing, or violation of community guidelines...', data: { controller: 'auto-expand' } %>
                    </fieldset>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <script>
            function updateVisibilityTitle(isVisible) {
              const title = document.getElementById('partner-visibility-title');
              title.textContent = isVisible ? 'Partner is visible' : 'Partner is hidden';
            }
          </script>
        <% end %>

        <div class="mt-8">
          <h2 class="text-lg font-bold text-error mb-4">Danger Zone</h2>
          <% if policy(@partner).destroy? %>
            <%= link_to @partner, method: :delete, class: "btn btn-error btn-sm", data: { confirm: "Delete this partner permanently? This cannot be undone." } do %>
              <%= icon(:trash, size: '4') %>
              Delete Partner
            <% end %>
          <% else %>
            <p class="text-sm text-base-content/60">You don't have permission to delete this partner.</p>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <%= render Admin::SaveBarComponent.new(
    multi_step: true,
    tab_name: 'partner_tabs',
    settings_hash: 'settings',
    preview_hash: 'preview',
    storage_key: 'partnerTabAfterSave'
  ) %>
<% end %>

<div id="map-pin-div" data-url="<%= image_path('icons/map/map-marker.png') %>"></div>
