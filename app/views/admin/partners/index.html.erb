<%
  # Get partnerships for filter dropdown, with counts
  partnership_counts = Partnership.joins(:partners).group('tags.id').count
  partnership_options = Partnership.where(id: partnership_counts.keys).order(:name).map do |p|
    { value: p.id.to_s, label: "#{p.name} (#{partnership_counts[p.id]})" }
  end

  # Get categories that have partners, with counts
  category_counts = Category.joins(:partners).group('tags.id').count
  category_options = Category.where(id: category_counts.keys).order(:name).map do |c|
    { value: c.id.to_s, label: "#{c.name} (#{category_counts[c.id]})" }
  end
%>

<%= render partial: "layouts/admin/datatable", locals: {
    title: "Partners",
    model: :partners,
    column_titles: [
      'Partner',
      'Neighbourhood',
      'Partnerships',
      icon_column_header(:calendar, 'Calendars'),
      icon_column_header(:users, 'Admins'),
      icon_column_header(:tag, 'Categories'),
      'Last Updated',
      ''
    ],
    columns: %i[name ward partnerships calendars admins categories updated_at actions],
    column_config: {
      name: {},
      ward: { sortable: false },
      partnerships: { sortable: false },
      calendars: { align: :center, sortable: false, fit: true },
      admins: { align: :center, sortable: false, fit: true },
      categories: { align: :center, sortable: false, fit: true },
      updated_at: { fit: true },
      actions: { sortable: false, fit: true }
    },
    default_sort: { column: 'updated_at', direction: 'desc' },
    filters: [
      {
        column: 'partnership',
        label: 'Partnership',
        options: partnership_options
      },
      {
        column: 'calendar_status',
        label: 'Calendar',
        width: 'w-28',
        options: [
          { value: 'connected', label: 'Connected' },
          { value: 'none', label: 'No calendar' }
        ]
      },
      {
        column: 'has_admins',
        label: 'Admins',
        width: 'w-28',
        options: [
          { value: 'yes', label: 'Has admins' },
          { value: 'no', label: 'No admins' }
        ]
      },
      {
        column: 'category',
        label: 'Category',
        width: 'w-28',
        options: category_options
      }
    ],
    secondary_filters: [
      {
        column: 'country_id',
        label: 'Country (L5)',
        width: 'min-w-40',
        type: :hierarchical,
        level: 5,
        endpoint: children_admin_neighbourhoods_path(format: :json),
        options: Neighbourhood.countries.latest_release.order(:name).map { |n|
          { value: n.id, label: n.name }
        }
      },
      {
        column: 'region_id',
        label: 'Region (L4)',
        width: 'min-w-48',
        type: :hierarchical,
        level: 4,
        parent_filter: 'country_id',
        endpoint: children_admin_neighbourhoods_path(format: :json)
      },
      {
        column: 'county_id',
        label: 'County (L3)',
        width: 'min-w-48',
        type: :hierarchical,
        level: 3,
        parent_filter: 'region_id',
        endpoint: children_admin_neighbourhoods_path(format: :json)
      },
      {
        column: 'district_id',
        label: 'District (L2)',
        width: 'min-w-48',
        type: :hierarchical,
        level: 2,
        parent_filter: 'county_id',
        endpoint: children_admin_neighbourhoods_path(format: :json)
      },
      {
        column: 'ward_id',
        label: 'Ward (L1)',
        width: 'min-w-48',
        type: :hierarchical,
        level: 1,
        parent_filter: 'district_id',
        endpoint: children_admin_neighbourhoods_path(format: :json)
      }
    ],
    data: @partners,
    source: admin_partners_path(format: :json),
    new_link: new_admin_partner_path
  }
%>
