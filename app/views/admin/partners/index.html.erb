<%
  # Get ward neighbourhoods grouped by district for hierarchical dropdown
  # Note: ancestry gem provides parent method, not association - use parent_name field instead
  wards = Neighbourhood.where(unit: 'ward').order(:name)
  ward_groups = wards.group_by { |w| w.parent_name.presence || 'Other' }
                     .sort_by { |district, _| district }
                     .map do |district, district_wards|
    {
      label: district,
      options: district_wards.sort_by(&:shortname).map { |w| { value: w.id.to_s, label: w.shortname } }
    }
  end

  # Get partnerships for filter dropdown
  partnership_options = Partnership.order(:name).map do |p|
    { value: p.id.to_s, label: p.name }
  end
%>

<%= render partial: "layouts/admin/datatable", locals: {
    title: "Partners",
    model: :partners,
    column_titles: ['Partner', 'Ward', 'Partnerships', 'Calendars', 'Admins', 'Categories', ''],
    columns: %i[name ward partnerships calendars admins categories actions],
    column_config: {
      name: { width: 'w-1/4' },
      ward: { width: 'w-36' },
      partnerships: { sortable: false, width: 'w-44' },
      calendars: { align: :center, sortable: false, width: 'w-12' },
      admins: { align: :center, sortable: false, width: 'w-12' },
      categories: { align: :center, sortable: false, width: 'w-12' },
      actions: { sortable: false, width: 'w-16' }
    },
    filters: [
      {
        column: 'calendar_status',
        label: 'Calendar',
        options: [
          { value: 'connected', label: 'Connected' },
          { value: 'none', label: 'No calendar' }
        ]
      },
      {
        column: 'has_admins',
        label: 'Admin users',
        options: [
          { value: 'yes', label: 'Has admins' },
          { value: 'no', label: 'No admins' }
        ]
      },
      {
        column: 'partnership',
        label: 'Partnership',
        options: partnership_options
      },
      {
        column: 'ward',
        label: 'Ward',
        groups: ward_groups
      }
    ],
    data: @partners,
    source: admin_partners_path(format: :json),
    new_link: new_admin_partner_path
  }
%>
