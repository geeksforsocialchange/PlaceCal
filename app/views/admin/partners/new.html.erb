<% content_for :title do %>New Partner<% end %>

<div class="max-w-4xl mx-auto"
     data-controller="partner-wizard"
     data-partner-wizard-current-step-value="1"
     data-partner-wizard-total-steps-value="3">

  <%# Header %>
  <div class="text-center mb-8">
    <h1 class="text-2xl font-bold text-base-content mb-2">Create a New Partner</h1>
    <p class="text-gray-600">Let's get your partner organisation set up in PlaceCal</p>
  </div>

  <%# Steps indicator %>
  <ul class="steps steps-horizontal w-full mb-8">
    <li class="step step-primary" data-partner-wizard-target="stepIndicator" data-step="1">
      <span class="step-content">Name</span>
    </li>
    <li class="step" data-partner-wizard-target="stepIndicator" data-step="2">
      <span class="step-content">Location</span>
    </li>
    <li class="step" data-partner-wizard-target="stepIndicator" data-step="3">
      <span class="step-content">Partnerships</span>
    </li>
  </ul>

  <%= simple_form_for @partner, html: { data: { partner_wizard_target: 'form' } } do |f| %>
    <%= render(Admin::ErrorComponent.new(@partner)) %>

    <%# Step 1: Name %>
    <div class="card bg-base-100 shadow-lg border border-base-300" data-partner-wizard-target="step" data-step="1">
      <div class="card-body">
        <div class="flex items-start gap-4 mb-6">
          <div class="shrink-0 w-12 h-12 rounded-xl bg-placecal-orange/10 flex items-center justify-center">
            <%= icon(:partner, size: '6', css_class: 'text-placecal-orange') %>
          </div>
          <div>
            <h2 class="card-title text-xl">Name Your Partner</h2>
            <p class="text-gray-600 text-sm mt-1">
              Enter the official name of the organisation. We'll check if it already exists.
            </p>
          </div>
        </div>

        <fieldset class="fieldset bg-base-200/50 rounded-xl p-6">
          <legend class="fieldset-legend text-base font-semibold">
            Partner Name <span class="text-error">*</span>
          </legend>
          <%= f.input_field :name,
              class: 'input input-bordered input-lg w-full text-lg',
              placeholder: 'e.g. Community Centre Name',
              autocomplete: 'off',
              'data-partner-wizard-target': 'nameInput',
              'data-action': 'input->partner-wizard#checkName' %>
          <p class="text-sm text-gray-600 mt-2">
            Must be at least 5 characters long
          </p>

          <%# Name validation feedback %>
          <div class="mt-4 hidden" data-partner-wizard-target="nameFeedback">
            <%# Exact match warning %>
            <div class="alert alert-warning text-sm hidden" data-partner-wizard-target="exactMatch">
              <%= icon(:warning, size: '5', css_class: 'shrink-0') %>
              <div>
                <p class="font-semibold">A partner with this exact name already exists</p>
                <p class="text-xs mt-1">You may want to edit the existing partner instead.</p>
              </div>
              <a href="#" class="btn btn-sm btn-warning" data-partner-wizard-target="exactMatchLink">View Partner</a>
            </div>

            <%# Similar partners %>
            <div class="hidden" data-partner-wizard-target="similarSection">
              <p class="text-sm font-medium text-base-content/70 mb-2 flex items-center gap-2">
                <%= icon(:info, size: '4') %>
                Partners with similar names:
              </p>
              <div class="space-y-1" data-partner-wizard-target="similarList"></div>
            </div>
          </div>
        </fieldset>

        <%# Name available indicator %>
        <div class="mt-4 hidden" data-partner-wizard-target="nameAvailable">
          <div class="alert alert-success text-sm">
            <%= icon(:check_circle, size: '5', css_class: 'shrink-0') %>
            <span>This name is available!</span>
          </div>
        </div>
      </div>
    </div>

    <%# Step 2: Location %>
    <div class="card bg-base-100 shadow-lg border border-base-300 hidden" data-partner-wizard-target="step" data-step="2">
      <div class="card-body">
        <div class="flex items-start gap-4 mb-6">
          <div class="shrink-0 w-12 h-12 rounded-xl bg-placecal-orange/10 flex items-center justify-center">
            <%= icon(:location, size: '6', css_class: 'text-placecal-orange') %>
          </div>
          <div>
            <h2 class="card-title text-xl">Set Location</h2>
            <p class="text-gray-600 text-sm mt-1">
              Where does this partner operate? Add a physical address and/or service areas.
            </p>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <%# Address %>
          <fieldset class="fieldset bg-base-200/50 rounded-xl p-5">
            <legend class="fieldset-legend font-semibold">Physical Address</legend>
            <p class="text-sm text-gray-600 mb-4">
              If this partner has a fixed location, enter it here.
            </p>
            <%= render Admin::AddressFieldsComponent.new(form: f, partner: @partner, current_user: current_user) %>
          </fieldset>

          <%# Service Areas %>
          <fieldset class="fieldset bg-base-200/50 rounded-xl p-5">
            <legend class="fieldset-legend font-semibold">Service Areas</legend>
            <p class="text-sm text-gray-600 mb-4">
              If this partner delivers services to wider areas (like outreach or phone support), add them here.
            </p>
            <div class="sites_neighbourhoods">
              <%= nested_form_for(f, :service_areas,
                    add_text: 'Add Service Area',
                    add_class: 'btn btn-sm bg-placecal-orange hover:bg-orange-600 text-white border-placecal-orange',
                    partial: 'service_area_fields') do %>
                <%= f.simple_fields_for :service_areas do |neighbourhood| %>
                  <%= render 'service_area_fields', f: neighbourhood %>
                <% end %>
              <% end %>
            </div>
          </fieldset>
        </div>
      </div>
    </div>

    <%# Step 3: Partnerships %>
    <div class="card bg-base-100 shadow-lg border border-base-300 hidden" data-partner-wizard-target="step" data-step="3">
      <div class="card-body">
        <div class="flex items-start gap-4 mb-6">
          <div class="shrink-0 w-12 h-12 rounded-xl bg-placecal-orange/10 flex items-center justify-center">
            <%= icon(:partnership, size: '6', css_class: 'text-placecal-orange') %>
          </div>
          <div>
            <h2 class="card-title text-xl">Add to Partnerships</h2>
            <p class="text-gray-600 text-sm mt-1">
              Which partnerships is this partner a member of?
            </p>
          </div>
        </div>

        <%= render 'partnership_fields', f: f %>
      </div>
    </div>

    <%# Save Bar %>
    <%= render Admin::SaveBarComponent.new(
      wizard: true,
      wizard_controller: 'partner-wizard',
      submit_label: t('admin.partners.actions.create')
    ) %>
  <% end %>
</div>
