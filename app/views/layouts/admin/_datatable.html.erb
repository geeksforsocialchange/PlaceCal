<% content_for :title do %><%= title %><% end %>

<%- model_name = model.to_s.chop.humanize %>
<%- filters_defined = defined?(filters) && filters.present? %>
<%- secondary_filters_defined = defined?(secondary_filters) && secondary_filters.present? %>
<%- all_filters = (filters_defined ? filters : []) + (secondary_filters_defined ? secondary_filters : []) %>

<%
  default_sort_col = defined?(default_sort) && default_sort ? default_sort[:column] : ''
  default_sort_dir = defined?(default_sort) && default_sort ? default_sort[:direction] : 'asc'
%>
<div class="bg-white shadow-sm rounded-xl overflow-hidden border border-gray-200"
     data-controller="admin-table"
     data-admin-table-source-value="<%= source %>"
     data-admin-table-columns-value="<%= columns.map { |c| { data: c.to_s, hidden: column_config&.dig(c, :hidden) || false } }.to_json %>"
     data-admin-table-page-length-value="25"
     data-admin-table-default-sort-column-value="<%= default_sort_col %>"
     data-admin-table-default-sort-direction-value="<%= default_sort_dir %>">

  <!-- Header -->
  <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-white">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-xl font-semibold text-gray-900"><%= title %></h1>
        <p class="mt-1 text-sm text-gray-500" data-admin-table-target="summary"><%= t('admin.labels.loading') %></p>
      </div>
      <%- if policy(model_name.constantize).create? && defined?(new_link) %>
        <%= link_to new_link, data: { turbo: false },
            class: "inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg text-white bg-orange-500 hover:bg-orange-600 transition-colors shadow-sm" do %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          <%= t('admin.actions.add_model', model: model_name) %>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- Filter Bar -->
  <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
    <%
      has_radio_filters = filters_defined && filters.any? { |f| f[:type] == :radio }
      has_dropdown_filters = filters_defined && filters.any? { |f| f[:type] != :radio }
      radio_filters = filters_defined ? filters.select { |f| f[:type] == :radio } : []
      ungrouped_filters = radio_filters.reject { |f| f[:group] }
      grouped_filters = radio_filters.select { |f| f[:group] }.group_by { |f| f[:group] }
    %>

    <!-- All filters on one line -->
    <div class="flex flex-wrap items-center gap-3">
      <!-- Search -->
      <% if defined?(search_fieldset) && search_fieldset %>
        <fieldset class="relative flex items-center px-3 py-2 pt-3 border border-gray-300 rounded-lg bg-gray-100">
          <legend class="font-medium text-gray-400 uppercase tracking-wider px-1 ml-1 bg-gray-50" style="font-size: 9px; line-height: 1;"><%= t('admin.datatable.search') %></legend>
          <div class="flex items-center gap-2">
            <svg class="h-3.5 w-3.5 text-gray-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input type="search"
                   class="w-44 bg-transparent text-xs text-gray-700 placeholder-gray-400 focus:outline-none"
                   placeholder="<%= t('admin.placeholders.type_to_filter') %>"
                   data-admin-table-target="search"
                   data-action="input->admin-table#search">
          </div>
        </fieldset>
      <% else %>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
          <input type="search"
                 class="block w-56 pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-xs placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                 placeholder="<%= t('admin.placeholders.search') %>"
                 data-admin-table-target="search"
                 data-action="input->admin-table#search">
        </div>
      <% end %>

      <% if has_dropdown_filters %>
        <!-- Dropdown Filters -->
        <% filters.each do |filter| %>
          <% next if filter[:type] == :radio %>
          <%
            is_hierarchical = filter[:type] == :hierarchical
            is_dependent = filter[:depends_on].present? || filter[:parent_filter].present?
            target_name = is_hierarchical ? "hierarchicalFilter" : (is_dependent ? "dependentFilter" : "filter")
            has_default = filter[:default].present?
            has_options = filter[:options].present?
          %>
          <select data-admin-table-target="<%= target_name %>"
                  data-filter-column="<%= filter[:column] %>"
                  <% if filter[:parent_filter] %>data-filter-parent="<%= filter[:parent_filter] %>"<% end %>
                  <% if filter[:depends_on] %>data-filter-depends-on="<%= filter[:depends_on] %>"<% end %>
                  <% if has_default %>data-filter-default="<%= filter[:default] %>"<% end %>
                  <% if is_hierarchical %>data-filter-level="<%= filter[:level] %>"<% end %>
                  <% if filter[:endpoint] %>data-filter-endpoint="<%= filter[:endpoint] %>"<% end %>
                  data-action="change->admin-table#applyFilter"
                  class="select-filter <%= 'hidden' if is_dependent %> <%= filter[:width] %>">
            <option value=""><%= filter[:label] %></option>
            <% filter[:options]&.each do |opt| %>
              <option value="<%= opt[:value] %>" <% if opt[:parent] %>data-parent="<%= opt[:parent] %>"<% end %> <% if has_default && filter[:default].to_s == opt[:value].to_s %>selected<% end %>><%= opt[:label] %></option>
            <% end %>
          </select>
        <% end %>
      <% end %>

      <% if has_radio_filters %>
        <%# Render ungrouped filters (each in its own fieldset) %>
        <% ungrouped_filters.each do |filter| %>
          <fieldset class="relative flex items-center gap-3 pl-3 pr-5 py-1.5 pt-2.5 border border-gray-300 rounded-lg bg-white/50" data-admin-table-target="radioFilter" data-filter-column="<%= filter[:column] %>">
            <legend class="font-medium text-gray-400 uppercase tracking-wider px-1 ml-1 bg-gray-50" style="font-size: 9px; line-height: 1;"><%= filter[:label] %></legend>
            <div class="inline-flex rounded-md bg-gray-100 p-0.5 mr-1">
              <button type="button"
                      data-action="click->admin-table#applyRadioFilter"
                      data-filter-value=""
                      data-is-all="true"
                      class="filter-btn filter-btn-all px-2 py-0.5 text-xs font-medium rounded transition-all duration-150 bg-white text-gray-900 shadow-sm"><%= t('admin.labels.all') %></button>
              <% filter[:options]&.each do |opt| %>
                <button type="button"
                        data-action="click->admin-table#applyRadioFilter"
                        data-filter-value="<%= opt[:value] %>"
                        class="filter-btn filter-btn-option px-2 py-0.5 text-xs font-medium rounded transition-all duration-150 text-gray-500 hover:text-gray-700"><%= opt[:label] %></button>
              <% end %>
            </div>
          </fieldset>
        <% end %>

        <%# Render grouped filters %>
        <% grouped_filters.each do |group_name, group_filters| %>
          <fieldset class="relative flex items-center gap-3 pl-3 pr-3 py-1.5 pt-2.5 border border-gray-300 rounded-lg bg-white/50">
            <legend class="font-medium text-gray-400 uppercase tracking-wider px-1 ml-1 bg-gray-50" style="font-size: 9px; line-height: 1;"><%= group_name %></legend>
            <% group_filters.each_with_index do |filter, idx| %>
              <% is_last = idx == group_filters.length - 1 %>
              <div class="flex items-center gap-2" data-admin-table-target="radioFilter" data-filter-column="<%= filter[:column] %>">
                <span class="text-xs font-medium text-gray-600"><%= filter[:label] %></span>
                <div class="inline-flex rounded-md bg-gray-100 p-0.5 <%= 'mr-1' if is_last %>">
                  <button type="button"
                          data-action="click->admin-table#applyRadioFilter"
                          data-filter-value=""
                          data-is-all="true"
                          class="filter-btn filter-btn-all px-2 py-0.5 text-xs font-medium rounded transition-all duration-150 bg-white text-gray-900 shadow-sm"><%= t('admin.labels.all') %></button>
                  <% filter[:options]&.each do |opt| %>
                    <button type="button"
                            data-action="click->admin-table#applyRadioFilter"
                            data-filter-value="<%= opt[:value] %>"
                            class="filter-btn filter-btn-option px-2 py-0.5 text-xs font-medium rounded transition-all duration-150 text-gray-500 hover:text-gray-700"><%= opt[:label] %></button>
                  <% end %>
                </div>
              </div>
            <% end %>
          </fieldset>
        <% end %>
      <% end %>

      <!-- Reset buttons -->
      <% if filters_defined || secondary_filters_defined %>
        <button type="button"
                data-action="click->admin-table#clearFilters"
                data-admin-table-target="clearFilters"
                style="display: none;"
                class="btn-clear-filters">
          <%= icon(:x, size: '3.5') %>
          <%= t('admin.datatable.clear_filters') %>
        </button>
      <% end %>
      <button type="button"
              data-action="click->admin-table#resetSort"
              data-admin-table-target="clearSort"
              style="display: none;"
              class="btn-clear-filters">
        <%= icon(:x, size: '3.5') %>
        <%= t('admin.datatable.reset_sort') %>
      </button>
    </div>

    <% if secondary_filters_defined %>
      <!-- Secondary Filters Row (Hierarchical) -->
      <div class="flex flex-wrap items-center gap-3 mt-3">
        <% secondary_filters.each do |filter| %>
          <%
            is_hierarchical = filter[:type] == :hierarchical
            is_dependent = filter[:parent_filter].present?
            target_name = is_hierarchical ? "hierarchicalFilter" : "filter"
            has_options = filter[:options].present?
          %>
          <select data-admin-table-target="<%= target_name %>"
                  data-filter-column="<%= filter[:column] %>"
                  <% if filter[:parent_filter] %>data-filter-parent="<%= filter[:parent_filter] %>"<% end %>
                  <% if is_hierarchical %>data-filter-level="<%= filter[:level] %>"<% end %>
                  <% if filter[:endpoint] %>data-filter-endpoint="<%= filter[:endpoint] %>"<% end %>
                  data-action="change->admin-table#applyFilter"
                  class="select-filter <%= 'hidden' if is_dependent %> <%= filter[:width] %>">
            <option value=""><%= filter[:label] %></option>
            <% filter[:options]&.each do |opt| %>
              <option value="<%= opt[:value] %>"><%= opt[:label] %></option>
            <% end %>
          </select>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full" data-admin-table-target="table">
      <thead>
        <tr class="bg-gray-50 border-b border-gray-200">
          <% column_titles.each_with_index do |col_title, index| %>
            <%
              col_config = defined?(column_config) && column_config[columns[index]]
              next if col_config&.dig(:hidden)
              sortable = col_config.nil? || col_config[:sortable] != false
              fit_content = col_config&.dig(:fit)
              width_class = fit_content ? 'w-px whitespace-nowrap' : (col_config&.dig(:width) || '')
              align_class = col_config&.dig(:align) == :center ? 'text-center' : 'text-left'
            %>
            <%
              sort_default_dir = col_config&.dig(:sort_default)
            %>
            <th data-column="<%= columns[index] %>"
                <% if sortable %>data-action="click->admin-table#sort"<% end %>
                <% if sort_default_dir %>data-sort-default="<%= sort_default_dir %>"<% end %>
                class="px-4 py-3 <%= align_class %> text-xs font-semibold text-gray-600 uppercase tracking-wider <%= width_class %> <%= 'cursor-pointer hover:bg-gray-100 select-none' if sortable %>">
              <div class="flex items-center gap-1 <%= 'justify-center' if col_config&.dig(:align) == :center %>">
                <%= col_title %>
                <% if sortable %>
                  <svg class="w-3 h-3 text-gray-400 opacity-0 group-hover:opacity-100" data-admin-table-target="sortIcon" data-column="<%= columns[index] %>" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                  </svg>
                <% end %>
              </div>
            </th>
          <% end %>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100" data-admin-table-target="tbody">
        <tr>
          <td colspan="<%= columns.length %>" class="px-6 py-12 text-center">
            <div class="flex flex-col items-center justify-center text-gray-500">
              <svg style="width: 2rem; height: 2rem; animation: spin 1s linear infinite; color: #e87d1e;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path style="opacity: 0.75;" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span class="mt-2 text-sm"><%= t('admin.datatable.loading') %></span>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Footer -->
  <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div data-admin-table-target="info" class="text-sm text-gray-600"></div>
    <nav aria-label="Table navigation">
      <ul class="inline-flex items-center gap-1" data-admin-table-target="pagination">
      </ul>
    </nav>
  </div>
</div>
